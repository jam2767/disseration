Eastern US NSC Analysis
========================================================

This is the analysis for chapter 2 of my dissertation and for the first paper on nonstructural carbohydrates in eastern US forests.



```{r}
#load libraries
library(lme4)
library(ggplot2)
library(plyr)
#library(ape) not compiling right now
library(gridExtra)
library(multcompView)
library(grid)

#helper functions
#function to find last value of vector
last <- function(x) { return( x[length(x)] ) }

#give sample size on boxplot for ggplot
give.n <- function(x){
  return(c(y = mean(x), label = length(x)))
}

#color-blind-friendly palettes
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

```{r}
#Directories for census and NSC data
#read data
#read Adult Census Data
#adult <- read.csv("/Users/Josh/Dropbox/Dietze_Lab_Undergrads/JAM - Xsite/Field Data Entry/Data Sheets/Adult_Field_Data_JAM_MCD.csv")

adult <- read.csv("/Users/josh/Dropbox/Dissertation/CH1_Treerings/Data/Adult_Field_Data_JAM_MCD.csv")

#read NSC tracking data - contains sample mass used for assays
mass <- read.csv("/Users/Josh/Dropbox/NSC_Runs/All/Tracking/NSC_Mass_All_8172016.csv")

#all files starch files in one directory
data.dir.starch = "/Users/Josh/Dropbox/NSC_Runs/All/Starch"
data.dir.sugar = "/Users/Josh/Dropbox/NSC_Runs/All/Sugar"
```

```{r}
### Process STARCH data files ###

#starch files
files.starch <- dir(data.dir.starch,"Xsite")
baseline.files.starch <- files.starch[grep(pattern = "Baseline",files.starch)]
HK.files.starch <- files.starch[grep(pattern = "HK",files.starch)]

baseline.starch = NULL
for(i in seq_along(baseline.files.starch)){
  tmp <- read.csv(file.path(data.dir.starch,baseline.files.starch[i]),sep="",colClasses="character")
  baseline.starch = rbind(baseline.starch,tmp)
}
#mean.baseline.starch <- tapply(X = as.numeric(baseline.starch$Meas.), INDEX = baseline.starch$Sample, FUN = mean) #using mean of baseline - used for analysis through 9/1/2016, switching to last for future analysis. Last represents most accurate starting point for subtracting from sample after Hexokinase (HK) added.
last.baseline.starch <- tapply(X = as.numeric(baseline.starch$Meas.), INDEX = baseline.starch$Sample, FUN = last)
baseline.starch.id <- unique(baseline.starch$Sample)

#these files contain a run after HK is added
#measures starch content via breakdown of glucose & production of NADPH
HK.starch = NULL
for(i in seq_along(HK.files.starch)){
  tmp.HK.starch <- read.csv(file.path(data.dir.starch,HK.files.starch[i]),sep="",colClasses="character")
  HK.starch = rbind(HK.starch,tmp.HK.starch)
}
max.HK.starch <- tapply(X = as.numeric(HK.starch$Meas.), INDEX = HK.starch$Sample, FUN = max)
HK.starch.id <- unique(HK.starch$Sample)

# Check that samples finished converting all Starch. If not, flag for reanalysis
dif.HK.starch <- tapply(X = as.numeric(HK.starch$Meas.), INDEX = HK.starch$Sample, FUN = diff)
IDs.starch <- as.vector(attr(dif.HK.starch,"dimnames"))
IDs.starch <- unlist(IDs)

starch.nofinish <- list()
for(i in 1:length(dif.HK.starch)){
if ('0' %in% dif.HK.starch[[i]]) { #simplest check: time when absorbance not increasing?
  print("Sample Finished")
  } else {
  starch.nofinish[[i]] <- IDs.starch[[i]] #ID of sample that didn't finish
  }
}

starch.nofinish.ids <- unlist(starch.nofinish) #remove null values
#write.csv(starch.nofinish.ids, file = "unfinished_starch.csv") #save file to identify repeats

#### right now still using values for samples that didn't finish

#difference between baseline and HK
#total.starch <- max.HK.starch-mean.baseline.starch #old method using mean baseline value before 9/1/2016
total.starch <- max.HK.starch-last.baseline.starch #new method using last baseline value


##TODO use each standard curve for each individual plate
##currently only using one standard curve
#create standard curve equation

standard.abs.starch <- c(mean(total.starch[3:4]),mean(total.starch[1:2]),
                         mean(total.starch[5:6]),mean(total.starch[7:8]))
#standard.conc.starch <- c(0,0.5,1.0,1.5) #standard glucose concentrations in mmol for plate 2
standard.conc.starch <- c(0,20,40,60) #standard concentrations * 40 uL
standard.lm.starch <- lm(standard.abs.starch ~ standard.conc.starch)
summary(standard.lm.starch) #slope, intercept, R^2

#visualize standard curve
plot(standard.conc.starch,standard.abs.starch)
abline(standard.lm.starch)

#standard curve equation - calculate mmol glucose equivalents of samples
sample.conc.starch <- (total.starch - standard.lm.starch$coefficients[1])/standard.lm.starch$coefficients[2]
sample.conc.starch <- as.matrix(sample.conc.starch)
sample.ids.starch <- strsplit(row.names(sample.conc.starch),"_")

###create ID to match Core_ID in adult census data
core.id.starch <- array()
for(i in 1:length(sample.conc.starch)){
  core.id.starch[i] <- paste0(sample.ids.starch[[i]][1],
                              sample.ids.starch[[i]][2],
                              sample.ids.starch[[i]][3])
}

##bind core.id to sample matrix
sample.starch <- data.frame(core.id.starch,sample.conc.starch)
sample.agg.starch <- aggregate(sample.conc.starch~core.id.starch,sample.starch,mean)
matches.starch <- match(as.character(sample.agg.starch$core.id),as.character(adult$Core_ID14))
row.names(sample.agg.starch) <- NULL
nsc.adult.dat.starch <- data.frame(sample.agg.starch,adult[matches.starch,])

#match sample masses to absorbance
matches.mass.starch <- match(as.character(nsc.adult.dat.starch$Core_ID14),as.character(mass$Core_ID))
nsc.adult.starch.mass <- data.frame(nsc.adult.dat.starch,mass[matches.mass.starch,])

#mass column is Mass_mg
#calculate concentrations based on mass of sample used
nsc.adult.starch.mass$ug.sample <- nsc.adult.starch.mass$sample.conc.starch / 40 * 840 #micrograms/sample 40 ul drawn from 840 ul total volume of Starch Extraction

##TODO subsample for files that contain samples with different volume than 840 ul because they needed their ph fixed##
nsc.adult.starch.mass$Starch.mg.g <- nsc.adult.starch.mass$ug.sample / nsc.adult.starch.mass$Mass_mg #mg/gram of sample

### END Process STARCH data files ###
```

```{r}
### Process SUGAR data files ###

#Sugar Files
files.sugar <- dir(data.dir.sugar,"Xsite")
baseline.files.sugar <- files.sugar[grep(pattern = "Baseline", files.sugar)]
glucose.files.sugar <- files.sugar[grep(pattern = "Glucose", files.sugar)]
fructose.files.sugar <- files.sugar[grep(pattern = "Fructose", files.sugar)]
sucrose.files.sugar <- files.sugar[grep(pattern = "Sucrose", files.sugar)]

baseline.sugar = NULL
for(i in seq_along(baseline.files.sugar)){
  tmp <- read.csv(file.path(data.dir.sugar,baseline.files.sugar[i]),sep="",colClasses="character")
  baseline.sugar = rbind(baseline.sugar,tmp)
}
# mean.baseline.sugar <- tapply(X = as.numeric(baseline.sugar$Meas.), INDEX = baseline.sugar$Sample, FUN = mean) #using mean of baseline - used for analysis through 9/1/2016, switching to last for future analysis. Last represents most accurate starting point for subtracting from sample after HK added.
last.baseline.sugar <- tapply(X = as.numeric(baseline.sugar$Meas.), INDEX = baseline.sugar$Sample, FUN = last)
baseline.sugar.id <- unique(baseline.sugar$Sample)

#these files contain a run after Hexokinase is added
#measures sugar content via breakdown of glucose & production of NADPH
glucose.sugar = NULL
for(i in seq_along(glucose.files.sugar)){
  tmp.glucose <- read.csv(file.path(data.dir.sugar,glucose.files.sugar[i]),sep="",colClasses="character")
  glucose.sugar = rbind(glucose.sugar,tmp.glucose)
}
max.glucose.sugar <- tapply(X = as.numeric(glucose.sugar$Meas.), INDEX = glucose.sugar$Sample, FUN = max)
glucose.sugar.id <- unique(glucose.sugar$Sample)

# Check that samples finished converting all glucose. If not, flag for reanalysis
dif.HK.sugar <- tapply(X = as.numeric(glucose.sugar$Meas.), INDEX = glucose.sugar$Sample, FUN = diff)
IDs.gluc <- as.vector(attr(dif.HK.sugar,"dimnames"))
IDs.gluc <- unlist(IDs.gluc)

gluc.nofinish <- list()
for(i in 1:length(dif.HK.sugar)){
if ('0' %in% dif.HK.sugar[[i]]) { #simplest check: time when absorbance not increasing?
  print("Sample Finished")
  } else {
  gluc.nofinish[[i]] <- IDs.gluc[[i]] #ID of sample that didn't finish
  }
}

gluc.nofinish.ids <- unlist(gluc.nofinish) #remove null values
#write.csv(gluc.nofinish.ids, file = "unfinished_glucose.csv") #save file to identify repeats


#difference between baseline and HK (glucose content)
total.glucose <- max.glucose.sugar-last.baseline.sugar #old method used mean.baseline.sugar

#these files contain  a run after hexokinase and PGI have been added
#measures sugar content via breakdown of fructose & production of NADPH
fructose.sugar = NULL
for(i in seq_along(fructose.files.sugar)){
  tmp.fructose <- read.csv(file.path(data.dir.sugar,fructose.files.sugar[i]),sep="",colClasses="character")
  fructose.sugar = rbind(fructose.sugar,tmp.fructose)
}
max.fructose.sugar <- tapply(X = as.numeric(fructose.sugar$Meas.), INDEX = fructose.sugar$Sample, FUN = max)
fructose.sugar.id <- unique(fructose.sugar$Sample)

#difference between HK and PGI (Fructose content)
last.glucose.sugar <- tapply(X = as.numeric(glucose.sugar$Meas.), INDEX = glucose.sugar$Sample, FUN = last)

# Check that samples finished converting all fructose. If not, flag for reanalysis
dif.PGI.sugar <- tapply(X = as.numeric(fructose.sugar$Meas.), INDEX = fructose.sugar$Sample, FUN = diff)
IDs.fruc <- as.vector(attr(dif.PGI.sugar,"dimnames"))
IDs.fruc <- unlist(IDs.fruc)

fruc.nofinish <- list()
for(i in 1:length(dif.PGI.sugar)){
if ('0' %in% dif.PGI.sugar[[i]]) { #simplest check: time when absorbance not increasing?
  print("Sample Finished")
  } else {
  fruc.nofinish[[i]] <- IDs.fruc[[i]] #ID of sample that didn't finish
  }
}

fruc.nofinish.ids <- unlist(fruc.nofinish) #remove null values
#write.csv(fruc.nofinish.ids, file = "unfinished_fructose.csv") #save file to identify repeats


total.fructose <- max.fructose.sugar-last.glucose.sugar

#these files contain  a run after hexokinase, PGI and Invertase have been added
#measures sugar content via breakdown of sucrose & production of NADPH
sucrose.sugar = NULL
for(i in seq_along(sucrose.files.sugar)){
  tmp.sucrose <- read.csv(file.path(data.dir.sugar,sucrose.files.sugar[i]),sep="",colClasses="character")
  sucrose.sugar = rbind(sucrose.sugar,tmp.sucrose)
}
max.sucrose.sugar <- tapply(X = as.numeric(sucrose.sugar$Meas.), INDEX = sucrose.sugar$Sample, FUN = max)
sucrose.sugar.id <- unique(sucrose.sugar$Sample)

# Check that samples finished converting all sucrose. If not, flag for reanalysis
dif.INV.sugar <- tapply(X = as.numeric(sucrose.sugar$Meas.), INDEX = sucrose.sugar$Sample, FUN = diff)
IDs.sucr <- as.vector(attr(dif.INV.sugar,"dimnames"))
IDs.sucr <- unlist(IDs.sucr)

sucr.nofinish <- list()
for(i in 1:length(dif.INV.sugar)){
if ('0' %in% dif.INV.sugar[[i]]) { #simplest check: time when absorbance not increasing?
  print("Sample Finished")
  } else {
  sucr.nofinish[[i]] <- IDs.sucr[[i]] #ID of sample that didn't finish
  }
}

sucr.nofinish.ids <- unlist(sucr.nofinish) #remove null values
#write.csv(sucr.nofinish.ids, file = "unfinished_sucrose.csv") #save file to identify repeats


#difference between HK and PGI (Fructose content)
last.fructose.sugar <- tapply(X = as.numeric(fructose.sugar$Meas.), INDEX = fructose.sugar$Sample, FUN = last)
total.sucrose <- max.sucrose.sugar-last.fructose.sugar

##TODO use each standard curve for each individual plate
##currenlty only using one standard curve
#create standard curve equation

standard.abs.sugar <- c(mean(total.glucose[3:4]),mean(total.glucose[1:2]),
                         mean(total.glucose[5:6]),mean(total.glucose[7:8]))
#standard.conc.starch <- c(0,0.5,1.0,1.5) #standard glucose concentrations in mmol for plate 2
standard.conc.sugar <- c(0,20,40,60) #standard concentrations * 40 uL
standard.lm.sugar <- lm(standard.abs.sugar ~ standard.conc.sugar)
summary(standard.lm.sugar) #slope, intercept, R^2

#visualize standard curve
plot(standard.conc.sugar,standard.abs.sugar)
abline(standard.lm.sugar)

#standard curve equation - calculate mmol glucose equivalents of samples
sample.conc.glucose <- ((total.glucose) - standard.lm.sugar$coefficients[1])/standard.lm.sugar$coefficients[2] #only 20ul of sample was used, compared to 40ul of standard
sample.conc.glucose <- as.matrix(sample.conc.glucose)
sample.ids.glucose <- strsplit(row.names(sample.conc.glucose),"_")

sample.conc.fructose <- ((total.fructose) - standard.lm.sugar$coefficients[1])/standard.lm.sugar$coefficients[2] #only 20ul of sample was used, compared to 40ul of standard
sample.conc.fructose <- as.matrix(sample.conc.fructose)
sample.ids.fructose <- strsplit(row.names(sample.conc.fructose),"_")

sample.conc.sucrose <- ((total.sucrose) - standard.lm.sugar$coefficients[1])/standard.lm.sugar$coefficients[2] #only 20ul of sample was used, compared to 40ul of standard
sample.conc.sucrose <- as.matrix(sample.conc.sucrose)
sample.ids.sucrose <- strsplit(row.names(sample.conc.sucrose),"_")

###create ID to match Core_ID in adult census data
core.id.sugar <- array()
for(i in 1:length(sample.conc.glucose)){
  core.id.sugar[i] <- paste0(sample.ids.glucose[[i]][1],
                              sample.ids.glucose[[i]][2],
                              sample.ids.glucose[[i]][3])
}

##bind core.id to sample matrix
sample.sugar <- data.frame(core.id.sugar,sample.conc.glucose,sample.conc.fructose,sample.conc.sucrose)
sample.agg.glucose <- aggregate(sample.conc.glucose ~ core.id.sugar, sample.sugar, mean)
sample.agg.fructose <- aggregate(sample.conc.fructose ~ core.id.sugar, sample.sugar, mean)
sample.agg.sucrose <- aggregate(sample.conc.sucrose ~ core.id.sugar, sample.sugar, mean)
sample.agg.sugar <- data.frame(sample.agg.glucose$core.id.sugar, sample.agg.glucose$sample.conc.glucose,
                               sample.agg.fructose$sample.conc.fructose, sample.agg.sucrose$sample.conc.sucrose)

matches.sugar <- match(as.character(sample.agg.sugar$sample.agg.glucose.core.id),as.character(adult$Core_ID14))
row.names(sample.agg.sugar) <- NULL
nsc.adult.dat.sugar <- data.frame(sample.agg.sugar,adult[matches.sugar,])

#match sample masses to absorbance
matches.mass.sugar <- match(as.character(nsc.adult.dat.sugar$Core_ID14),as.character(mass$Core_ID))
nsc.adult.sugar.mass <- data.frame(nsc.adult.dat.sugar,mass[matches.mass.sugar,])

#mass column is Mass_mg
#calculate concentrations of glucose based on mass of sample used
nsc.adult.sugar.mass$ug.glucose <- nsc.adult.sugar.mass$sample.agg.glucose.sample.conc.glucose / 20 * 845 #micrograms/sample 20 ul drawn from 845 ul total volume of Sugar Extraction
nsc.adult.sugar.mass$glucose.mg.g <- nsc.adult.sugar.mass$ug.glucose / nsc.adult.sugar.mass$Mass_mg #mg/gram of sample

#calculate concentrations of fructose based on mass of sample used
nsc.adult.sugar.mass$ug.fructose <- nsc.adult.sugar.mass$sample.agg.fructose.sample.conc.fructose / 20 * 845 #micrograms/sample 20 ul drawn from 845 ul total volume of Sugar Extraction
nsc.adult.sugar.mass$fructose.mg.g <- nsc.adult.sugar.mass$ug.fructose / nsc.adult.sugar.mass$Mass_mg #mg/gram of sample

#calculate concentrations of fructose based on mass of sample used
nsc.adult.sugar.mass$ug.sucrose <- nsc.adult.sugar.mass$sample.agg.sucrose.sample.conc.sucrose / 20 * 845 #micrograms/sample 20 ul drawn from 845 ul total volume of Sugar Extraction
nsc.adult.sugar.mass$sucrose.mg.g <- nsc.adult.sugar.mass$ug.sucrose / nsc.adult.sugar.mass$Mass_mg #mg/gram of sample

### END process SUGAR files ###
```

Combining data from sugar and starch runs into one dataframe

```{r}
### Combine Sugar and Starch for total NSC ###
starch.only <- data.frame(nsc.adult.starch.mass$core.id.starch,nsc.adult.starch.mass$Starch.mg.g)
matches.sugar.starch <- match(as.character(nsc.adult.sugar.mass$sample.agg.glucose.core.id.sugar),as.character(starch.only$nsc.adult.starch.mass.core.id.starch))
row.names(nsc.adult.sugar.mass) <- NULL
row.names(starch.only) <- NULL
nsc.adult.total.mass <- data.frame(nsc.adult.sugar.mass,starch.only[matches.sugar.starch,])
nsc.adult.total.mass$total.nsc <- mapply(nsc.adult.total.mass$nsc.adult.starch.mass.Starch.mg.g,
                                      nsc.adult.total.mass$glucose.mg.g,
                                      nsc.adult.total.mass$fructose.mg.g,
                                      nsc.adult.total.mass$sucrose.mg.g, FUN=sum, na.rm=FALSE)                                      
#rename starch column
colnames(nsc.adult.total.mass)[115] <- "core.id.starch"
colnames(nsc.adult.total.mass)[116] <- "starch.mg.g"

#csv to identify missing starch or sugar samples
#write.csv(nsc.adult.total.mass, file = "nsc.adult.total.mass.missingincluded.csv")

#remove NAs for total.nsc
nsc.adult.total.mass <- nsc.adult.total.mass[which(nsc.adult.total.mass$total.nsc != "NA"),]

### END combine sugar and starch ###
```

Adding Plant Functional Type (PFT) and Wood Anatomy as covariates for analysis. USDA PLANTS database and USFS Silvics of North America manual used for PFT determination.

```{r}
### Adding PFT and Wood Anatomy covariates ###

##adding PFTs
###Reference: http://plants.usda.gov/java/
### Also USFS silvics manual: https://www.na.fs.fed.us/spfo/pubs/silvics_manual/table_of_contents.htm

# Hardwoods
Early.Hardwood <- c(
                    which(nsc.adult.total.mass$Spp == "ACPE"),#
                    which(nsc.adult.total.mass$Spp == "AIAL"),#
                    which(nsc.adult.total.mass$Spp == "BEAL2"),#
                    which(nsc.adult.total.mass$Spp == "BELE"),#
                    which(nsc.adult.total.mass$Spp == "BEPA"),#
                    which(nsc.adult.total.mass$Spp == "BETUL"),#
                    which(nsc.adult.total.mass$Spp == "COFL2"),#
                    which(nsc.adult.total.mass$Spp == "JUCI"),#
                    which(nsc.adult.total.mass$Spp == "JUNI"),#
                    which(nsc.adult.total.mass$Spp == "LIST2"),#
                    which(nsc.adult.total.mass$Spp == "LITU"),#
                    which(nsc.adult.total.mass$Spp == "POGR4"),#
                    which(nsc.adult.total.mass$Spp == "POTR5"),#
                    which(nsc.adult.total.mass$Spp == "PRSE2"),#
                    which(nsc.adult.total.mass$Spp == "ROPS"),#
                    which(nsc.adult.total.mass$Spp == "SAAL5")#
                    ) #16 Spp

Mid.Hardwood <- c(
                  which(nsc.adult.total.mass$Spp == "FRAM2"),#
                  which(nsc.adult.total.mass$Spp == "FRNI"),#
                  which(nsc.adult.total.mass$Spp == "FRQU"),#
                  which(nsc.adult.total.mass$Spp == "ACNE2"),#
                  which(nsc.adult.total.mass$Spp == "ACRU"),#
                  which(nsc.adult.total.mass$Spp == "CACA18"),#
                  which(nsc.adult.total.mass$Spp == "CACO15"),#
                  which(nsc.adult.total.mass$Spp == "CAGL8"),#
                  which(nsc.adult.total.mass$Spp == "CALA21"),#
                  which(nsc.adult.total.mass$Spp == "CAOV2"),#
                  which(nsc.adult.total.mass$Spp == "CATO6"),#
                  which(nsc.adult.total.mass$Spp == "CECA4"),#
                  which(nsc.adult.total.mass$Spp == "MAAC"),#
                  which(nsc.adult.total.mass$Spp == "MAFR"),#
                  which(nsc.adult.total.mass$Spp == "MAVI2"),#
                  which(nsc.adult.total.mass$Spp == "PLOC"),#
                  which(nsc.adult.total.mass$Spp == "QUAL"),#
                  which(nsc.adult.total.mass$Spp == "QUCO2"),#
                  which(nsc.adult.total.mass$Spp == "QUERC"),#
                  which(nsc.adult.total.mass$Spp == "QUIM"),#
                  which(nsc.adult.total.mass$Spp == "QULA2"),#
                  which(nsc.adult.total.mass$Spp == "QULA3"),#
                  which(nsc.adult.total.mass$Spp == "QUMO4"),#
                  which(nsc.adult.total.mass$Spp == "QUMU"),#
                  which(nsc.adult.total.mass$Spp == "QUNI"),#
                  which(nsc.adult.total.mass$Spp == "QUPH"),#
                  which(nsc.adult.total.mass$Spp == "QURU"),#
                  which(nsc.adult.total.mass$Spp == "QUST"),#
                  which(nsc.adult.total.mass$Spp == "QUVE"),#
                  which(nsc.adult.total.mass$Spp == "QUVI"),#
                  which(nsc.adult.total.mass$Spp == "ULAM")#
                  ) #31 Spp

Late.Hardwood <- c(
                  which(nsc.adult.total.mass$Spp == "ACFL"),#
                  which(nsc.adult.total.mass$Spp == "ACSA3"),#
                  which(nsc.adult.total.mass$Spp == "AEGL"),#
                  which(nsc.adult.total.mass$Spp == "DIVI5"),#
                  which(nsc.adult.total.mass$Spp == "FAGR"),#
                  which(nsc.adult.total.mass$Spp == "MAGR4"),#
                  which(nsc.adult.total.mass$Spp == "NYSY"),#
                  which(nsc.adult.total.mass$Spp == "OXAR"),#
                  which(nsc.adult.total.mass$Spp == "TIAM")#
                  ) #9 Spp

# set PFTs
nsc.adult.total.mass$PFT <- NA
nsc.adult.total.mass$PFT[Early.Hardwood] <- "Early.Hardwood"
nsc.adult.total.mass$PFT[Mid.Hardwood] <- "Mid.Hardwood"
nsc.adult.total.mass$PFT[Late.Hardwood] <- "Late.Hardwood"

# Conifers
Early.Conifer <- c(
                  which(nsc.adult.total.mass$Spp == "ABBA"),#
                  which(nsc.adult.total.mass$Spp == "JUVI"),#
                  which(nsc.adult.total.mass$Spp == "PIPA2"),#
                  which(nsc.adult.total.mass$Spp == "PIST"),#
                  which(nsc.adult.total.mass$Spp == "PIVI2"),#
                  which(nsc.adult.total.mass$Spp == "PIRE"),#
                  which(nsc.adult.total.mass$Spp == "PIRI"),#
                  which(nsc.adult.total.mass$Spp == "PITA")#
                  ) #8 Spp

Late.Conifer <- c(
                  which(nsc.adult.total.mass$Spp == "LALA"),#
                  which(nsc.adult.total.mass$Spp == "PIGL"),#
                  which(nsc.adult.total.mass$Spp == "PIMA"),#
                  which(nsc.adult.total.mass$Spp == "PIRU"),#
                  which(nsc.adult.total.mass$Spp == "THOC2"),#
                  which(nsc.adult.total.mass$Spp == "TSCA")#
                  ) #6 Spp

nsc.adult.total.mass$PFT[Early.Conifer] <- "Early.Conifer"
nsc.adult.total.mass$PFT[Late.Conifer] <- "Late.Conifer"

# adding wood anatomy
###Reference http://www.wood-database.com/
###Disagree with reference for hickory classification - put all as semi-ring porous. conferred with Christy

large.resin <- c(
                which(nsc.adult.total.mass$Spp == "PIPA2"),
                which(nsc.adult.total.mass$Spp == "PIST"),
                which(nsc.adult.total.mass$Spp == "PIVI2"),
                which(nsc.adult.total.mass$Spp == "PIRE"),
                which(nsc.adult.total.mass$Spp == "PIRI"),
                which(nsc.adult.total.mass$Spp == "PITA")
                )

small.resin <- c(
                which(nsc.adult.total.mass$Spp == "LALA"),
                which(nsc.adult.total.mass$Spp == "PIGL"),
                which(nsc.adult.total.mass$Spp == "PIMA"),
                which(nsc.adult.total.mass$Spp == "PIRU")
                )

no.resin <- c(
              which(nsc.adult.total.mass$Spp == "ABBA"),
              which(nsc.adult.total.mass$Spp == "JUVI"),
              which(nsc.adult.total.mass$Spp == "THOC2"),
              which(nsc.adult.total.mass$Spp == "TSCA")
              )

ring.porous <- c(
                which(nsc.adult.total.mass$Spp == "AIAL"),              
                which(nsc.adult.total.mass$Spp == "FRAM2"),
                which(nsc.adult.total.mass$Spp == "FRNI"),
                which(nsc.adult.total.mass$Spp == "FRQU"),
                which(nsc.adult.total.mass$Spp == "QUAL"),
                which(nsc.adult.total.mass$Spp == "QUCO2"),
                which(nsc.adult.total.mass$Spp == "QUERC"),
                which(nsc.adult.total.mass$Spp == "QUIM"),
                which(nsc.adult.total.mass$Spp == "QULA2"),
                which(nsc.adult.total.mass$Spp == "QULA3"),
                which(nsc.adult.total.mass$Spp == "QUMO4"),
                which(nsc.adult.total.mass$Spp == "QUMU"),
                which(nsc.adult.total.mass$Spp == "QUNI"),
                which(nsc.adult.total.mass$Spp == "QUPH"),
                which(nsc.adult.total.mass$Spp == "QURU"),
                which(nsc.adult.total.mass$Spp == "QUST"),
                which(nsc.adult.total.mass$Spp == "QUVE"),
                which(nsc.adult.total.mass$Spp == "QUVI"),
                which(nsc.adult.total.mass$Spp == "ROPS"),
                which(nsc.adult.total.mass$Spp == "SAAL5")
                )

diffuse.porous <- c(
                    which(nsc.adult.total.mass$Spp == "ACNE2"),
                    which(nsc.adult.total.mass$Spp == "ACPE"),
                    which(nsc.adult.total.mass$Spp == "ACRU"),
                    which(nsc.adult.total.mass$Spp == "ACSA3"),
                    which(nsc.adult.total.mass$Spp == "AEGL"),
                    which(nsc.adult.total.mass$Spp == "BEAL2"),
                    which(nsc.adult.total.mass$Spp == "BELE"),
                    which(nsc.adult.total.mass$Spp == "BEPA"),
                    which(nsc.adult.total.mass$Spp == "BETUL"),
                    which(nsc.adult.total.mass$Spp == "CACA18"),
                    which(nsc.adult.total.mass$Spp == "COFL2"),
                    which(nsc.adult.total.mass$Spp == "LIST2"),
                    which(nsc.adult.total.mass$Spp == "LITU"),
                    which(nsc.adult.total.mass$Spp == "MAAC"),
                    which(nsc.adult.total.mass$Spp == "MAFR"),
                    which(nsc.adult.total.mass$Spp == "MAVI2"),                  
                    which(nsc.adult.total.mass$Spp == "PLOC"),
                    which(nsc.adult.total.mass$Spp == "FAGR"),
                    which(nsc.adult.total.mass$Spp == "MAGR4"),
                    which(nsc.adult.total.mass$Spp == "NYSY"),
                    which(nsc.adult.total.mass$Spp == "OXAR"),
                    which(nsc.adult.total.mass$Spp == "TIAM"),
                    which(nsc.adult.total.mass$Spp == "POGR4"),
                    which(nsc.adult.total.mass$Spp == "POTR5"),
                    which(nsc.adult.total.mass$Spp == "PRSE2")               
                    )

semiring.porous <- c(
                    which(nsc.adult.total.mass$Spp == "CACO15"),
                    which(nsc.adult.total.mass$Spp == "CAGL8"),
                    which(nsc.adult.total.mass$Spp == "CALA21"),
                    which(nsc.adult.total.mass$Spp == "CAOV2"),
                    which(nsc.adult.total.mass$Spp == "CATO6"),
                    which(nsc.adult.total.mass$Spp == "CECA4"),
                    which(nsc.adult.total.mass$Spp == "DIVI5"), #bordering diffuse porous
                    which(nsc.adult.total.mass$Spp == "JUCI"),
                    which(nsc.adult.total.mass$Spp == "JUNI"),
                    which(nsc.adult.total.mass$Spp == "ULAM")                                   
                    )

#set anatomy
nsc.adult.total.mass$wood <- NA
nsc.adult.total.mass$wood[large.resin] <- "large.resin"
nsc.adult.total.mass$wood[small.resin] <- "small.resin"
nsc.adult.total.mass$wood[no.resin] <- "no.resin"
nsc.adult.total.mass$wood[ring.porous] <- "ring.porous"
nsc.adult.total.mass$wood[diffuse.porous] <- "diffuse.porous"
nsc.adult.total.mass$wood[semiring.porous] <- "semiring.porous"

#Relevel Factors
nsc.adult.total.mass$wood <- factor(nsc.adult.total.mass$wood, 
                                    levels = c("large.resin","small.resin","no.resin",
                                               "ring.porous","semiring.porous",
                                               "diffuse.porous"), ordered = TRUE)



###Reference: http://plants.usda.gov/java/
# adding species string
    alba <- which(nsc.adult.total.mass$Spp == "QUAL")
    coccinea <- which(nsc.adult.total.mass$Spp == "QUCO2")
    none <- c(which(nsc.adult.total.mass$Spp == "QUERC"),
              which(nsc.adult.total.mass$Spp == "BETUL"))
    imbricaria <- which(nsc.adult.total.mass$Spp == "QUIM")
    laevis <- which(nsc.adult.total.mass$Spp == "QULA2")
    laurifolia <- which(nsc.adult.total.mass$Spp == "QULA3")
    montana <- which(nsc.adult.total.mass$Spp == "QUMO4")
    muehlenbergii <- which(nsc.adult.total.mass$Spp == "QUMU")
    nigra <- c(which(nsc.adult.total.mass$Spp == "QUNI"),
               which(nsc.adult.total.mass$Spp == "FRNI"),
               which(nsc.adult.total.mass$Spp == "JUNI"))
    phellos <- which(nsc.adult.total.mass$Spp == "QUPH")
    rubra <- which(nsc.adult.total.mass$Spp == "QURU")
    stellata <- which(nsc.adult.total.mass$Spp == "QUST")
    velutina <- which(nsc.adult.total.mass$Spp == "QUVE")
    virginiana <- c(which(nsc.adult.total.mass$Spp == "QUVI"),
                  which(nsc.adult.total.mass$Spp == "MAVI2"),
                  which(nsc.adult.total.mass$Spp == "DIVI5"),
                  which(nsc.adult.total.mass$Spp == "PIVI2"),
                  which(nsc.adult.total.mass$Spp == "JUVI"))
    americana <- c(which(nsc.adult.total.mass$Spp == "FRAM2"),
                   which(nsc.adult.total.mass$Spp == "TIAM"),
                   which(nsc.adult.total.mass$Spp == "ULAM"))
    quadrangulata <- which(nsc.adult.total.mass$Spp == "FRQU")
    altissima <- which(nsc.adult.total.mass$Spp == "AIAL")
    pseudoacacia <- which(nsc.adult.total.mass$Spp == "ROPS")
    albidum <- which(nsc.adult.total.mass$Spp == "SAAL5")
    negundo <- which(nsc.adult.total.mass$Spp == "ACNE2")
    pensylvanicum <- which(nsc.adult.total.mass$Spp == "ACPE")
    rubrum <- which(nsc.adult.total.mass$Spp == "ACRU")
    saccharum <- which(nsc.adult.total.mass$Spp == "ACSA3")
    glabra <- c(which(nsc.adult.total.mass$Spp == "AEGL"),
                which(nsc.adult.total.mass$Spp == "CAGL8"))
    alleghaniensis <- which(nsc.adult.total.mass$Spp == "BEAL2")
    lenta <- which(nsc.adult.total.mass$Spp == "BELE")
    papyrifera <- which(nsc.adult.total.mass$Spp == "BEPA")
    caroliniana <- which(nsc.adult.total.mass$Spp == "CACA18")
    florida <- which(nsc.adult.total.mass$Spp == "COFL2")
    styraciflua <- which(nsc.adult.total.mass$Spp == "LIST2")
    tulipifera <- which(nsc.adult.total.mass$Spp == "LITU")
    acuminata <- which(nsc.adult.total.mass$Spp == "MAAC")
    fraseri <- which(nsc.adult.total.mass$Spp == "MAFR")
    grandiflora <- which(nsc.adult.total.mass$Spp == "MAGR4")
    occidentalis <- which(nsc.adult.total.mass$Spp == "PLOC")
    grandifolia <- which(nsc.adult.total.mass$Spp == "FAGR")
    sylvatica <- which(nsc.adult.total.mass$Spp == "NYSY")
    arboreum <- which(nsc.adult.total.mass$Spp == "OXAR")
    grandidentata <- which(nsc.adult.total.mass$Spp == "POGR4")
    tremuloides <- which(nsc.adult.total.mass$Spp == "POTR5")
    serotina <- which(nsc.adult.total.mass$Spp == "PRSE2")
    cordiformis <- which(nsc.adult.total.mass$Spp == "CACO15")
    laciniosa <- which(nsc.adult.total.mass$Spp == "CALA21")
    ovata <- which(nsc.adult.total.mass$Spp == "CAOV2")
    tomentosa <- which(nsc.adult.total.mass$Spp == "CATO6")
    canadensis <- c(which(nsc.adult.total.mass$Spp == "CECA4"),
                    which(nsc.adult.total.mass$Spp == "TSCA"))
    cinerea <- which(nsc.adult.total.mass$Spp == "JUCI")
    palustris <- which(nsc.adult.total.mass$Spp == "PIPA2")
    strobus <- which(nsc.adult.total.mass$Spp == "PIST")
    resinosa <- which(nsc.adult.total.mass$Spp == "PIRE")
    rigida <- which(nsc.adult.total.mass$Spp == "PIRI")
    taeda <- which(nsc.adult.total.mass$Spp == "PITA")
    laricina <- which(nsc.adult.total.mass$Spp == "LALA")
    glauca <- which(nsc.adult.total.mass$Spp == "PIGL")
    mariana <- which(nsc.adult.total.mass$Spp == "PIMA")
    rubens <- which(nsc.adult.total.mass$Spp == "PIRU")
    balsamea <- which(nsc.adult.total.mass$Spp == "ABBA")
    occidentalis <- which(nsc.adult.total.mass$Spp == "THOC2")
    
    ### Set total dataframe for species
    
    nsc.adult.total.mass$species <- NA
    nsc.adult.total.mass$species[alba] <- "alba"
    nsc.adult.total.mass$species[coccinea] <- "coccinea"
    nsc.adult.total.mass$species[none] <- "none"
    nsc.adult.total.mass$species[imbricaria] <- "imbricaria"
    nsc.adult.total.mass$species[laevis] <- "laevis"
    nsc.adult.total.mass$species[laurifolia] <- "laurifolia"
    nsc.adult.total.mass$species[montana] <- "montana"
    nsc.adult.total.mass$species[muehlenbergii] <- "muehlenbergii"
    nsc.adult.total.mass$species[nigra] <- "nigra"
    nsc.adult.total.mass$species[phellos] <- "phellos"
    nsc.adult.total.mass$species[rubra] <- "rubra"
    nsc.adult.total.mass$species[stellata] <- "stellata"
    nsc.adult.total.mass$species[velutina] <- "velutina"
    nsc.adult.total.mass$species[virginiana] <- "virginiana"
    nsc.adult.total.mass$species[americana] <- "americana"
    nsc.adult.total.mass$species[quadrangulata] <- "quadrangulata"
    nsc.adult.total.mass$species[altissima] <- "altissima"
    nsc.adult.total.mass$species[pseudoacacia] <- "pseudoacacia"
    nsc.adult.total.mass$species[albidum] <- "albidum"
    nsc.adult.total.mass$species[negundo] <- "negundo"
    nsc.adult.total.mass$species[pensylvanicum] <- "pensylvanicum"
    nsc.adult.total.mass$species[rubrum] <- "rubrum"
    nsc.adult.total.mass$species[saccharum] <- "saccharum"
    nsc.adult.total.mass$species[glabra] <- "glabra"
    nsc.adult.total.mass$species[alleghaniensis] <- "alleghaniensis"
    nsc.adult.total.mass$species[lenta] <- "lenta"
    nsc.adult.total.mass$species[papyrifera] <- "papyrifera"
    nsc.adult.total.mass$species[caroliniana] <- "caroliniana"
    nsc.adult.total.mass$species[florida] <- "florida"
    nsc.adult.total.mass$species[styraciflua] <- "styraciflua"
    nsc.adult.total.mass$species[tulipifera] <- "tulipifera"
    nsc.adult.total.mass$species[acuminata] <- "acuminata"
    nsc.adult.total.mass$species[fraseri] <- "fraseri"
    nsc.adult.total.mass$species[grandiflora] <- "grandiflora"
    nsc.adult.total.mass$species[occidentalis] <- "occidentalis"
    nsc.adult.total.mass$species[grandifolia] <- "grandifolia"
    nsc.adult.total.mass$species[sylvatica] <- "sylvatica"
    nsc.adult.total.mass$species[arboreum] <- "arboreum"
    nsc.adult.total.mass$species[grandidentata] <- "grandidentata"
    nsc.adult.total.mass$species[tremuloides] <- "tremuloides"
    nsc.adult.total.mass$species[serotina] <- "serotina"
    nsc.adult.total.mass$species[cordiformis] <- "cordiformis"
    nsc.adult.total.mass$species[laciniosa] <- "laciniosa"
    nsc.adult.total.mass$species[ovata] <- "ovata"
    nsc.adult.total.mass$species[tomentosa] <- "tomentosa"
    nsc.adult.total.mass$species[canadensis] <- "canadensis"
    nsc.adult.total.mass$species[cinerea] <- "cinerea"
    nsc.adult.total.mass$species[palustris] <- "palustris"
    nsc.adult.total.mass$species[strobus] <- "strobus"
    nsc.adult.total.mass$species[resinosa] <- "resinosa"
    nsc.adult.total.mass$species[rigida] <- "rigida"
    nsc.adult.total.mass$species[taeda] <- "taeda"
    nsc.adult.total.mass$species[laricina] <- "laricina"
    nsc.adult.total.mass$species[glauca] <- "glauca"
    nsc.adult.total.mass$species[mariana] <- "mariana"
    nsc.adult.total.mass$species[rubens] <- "rubens"
    nsc.adult.total.mass$species[balsamea] <- "balsamea"
    nsc.adult.total.mass$species[occidentalis] <- "occidentalis"

# adding genus and family
  ### Hardwoods

    Quercus <- c(                
                which(nsc.adult.total.mass$Spp == "QUAL"),
                which(nsc.adult.total.mass$Spp == "QUCO2"),
                which(nsc.adult.total.mass$Spp == "QUERC"),
                which(nsc.adult.total.mass$Spp == "QUIM"),
                which(nsc.adult.total.mass$Spp == "QULA2"),
                which(nsc.adult.total.mass$Spp == "QULA3"),
                which(nsc.adult.total.mass$Spp == "QUMO4"),
                which(nsc.adult.total.mass$Spp == "QUMU"),
                which(nsc.adult.total.mass$Spp == "QUNI"),
                which(nsc.adult.total.mass$Spp == "QUPH"),
                which(nsc.adult.total.mass$Spp == "QURU"),
                which(nsc.adult.total.mass$Spp == "QUST"),
                which(nsc.adult.total.mass$Spp == "QUVE"),
                which(nsc.adult.total.mass$Spp == "QUVI")
                )
    
   Fraxinus <- c(
                which(nsc.adult.total.mass$Spp == "FRAM2"),
                which(nsc.adult.total.mass$Spp == "FRNI"),
                which(nsc.adult.total.mass$Spp == "FRQU")
                )
   
  Ailanthus <- c(
                which(nsc.adult.total.mass$Spp == "AIAL")
                )
   
    Robinia <- c(
                which(nsc.adult.total.mass$Spp == "ROPS")
                )
    
  Sassafras <- c(
                which(nsc.adult.total.mass$Spp == "SAAL5")
                )
  
      Acer <- c(
                which(nsc.adult.total.mass$Spp == "ACNE2"),
                which(nsc.adult.total.mass$Spp == "ACPE"),
                which(nsc.adult.total.mass$Spp == "ACRU"),
                which(nsc.adult.total.mass$Spp == "ACSA3")
                )
      
  Aesculus <- c(
                which(nsc.adult.total.mass$Spp == "AEGL")
                )
  
    Betula <- c(
                which(nsc.adult.total.mass$Spp == "BEAL2"),
                which(nsc.adult.total.mass$Spp == "BELE"),
                which(nsc.adult.total.mass$Spp == "BEPA"),
                which(nsc.adult.total.mass$Spp == "BETUL")
                )
    
  Carpinus <- c(
                which(nsc.adult.total.mass$Spp == "CACA18")
                )
    
    Cornus <- c(
                which(nsc.adult.total.mass$Spp == "COFL2")
                )
    
Liquidambar <- c(
                which(nsc.adult.total.mass$Spp == "LIST2")
                )

Liriodendron <- c(
                which(nsc.adult.total.mass$Spp == "LITU")
                )

    Magnolia <- c(
                which(nsc.adult.total.mass$Spp == "MAAC"),
                which(nsc.adult.total.mass$Spp == "MAFR"),
                which(nsc.adult.total.mass$Spp == "MAVI2"),
                which(nsc.adult.total.mass$Spp == "MAGR4")
                )
    
    Platanus <- c(
                which(nsc.adult.total.mass$Spp == "PLOC")
                )
    
       Fagus <- c(
                which(nsc.adult.total.mass$Spp == "FAGR")
                )
       
       Nyssa <- c(
                which(nsc.adult.total.mass$Spp == "NYSY")
                )
       
       Oxydendrum <- c(
                which(nsc.adult.total.mass$Spp == "OXAR")
                )
       
       Tilia <- c(
                which(nsc.adult.total.mass$Spp == "TIAM")
                )
    
     Populus <- c(
                which(nsc.adult.total.mass$Spp == "POGR4"),
                which(nsc.adult.total.mass$Spp == "POTR5")
                )
       
     Prunus <- c(
                which(nsc.adult.total.mass$Spp == "PRSE2")
                )

       Carya <- c(
                which(nsc.adult.total.mass$Spp == "CACO15"),
                which(nsc.adult.total.mass$Spp == "CAGL8"),
                which(nsc.adult.total.mass$Spp == "CALA21"),
                which(nsc.adult.total.mass$Spp == "CAOV2"),
                which(nsc.adult.total.mass$Spp == "CATO6")
                )
       
     Cercis <- c(
                which(nsc.adult.total.mass$Spp == "CECA4")
                )
     
  Diospyros <- c(
                which(nsc.adult.total.mass$Spp == "DIVI5")
                )
  
    Juglans <- c(
                which(nsc.adult.total.mass$Spp == "JUCI"),
                which(nsc.adult.total.mass$Spp == "JUNI")
                )
    
      Ulmus <- c(
                which(nsc.adult.total.mass$Spp == "ULAM")
                )

  ### Conifers
      Pinus <- c(
                which(nsc.adult.total.mass$Spp == "PIPA2"),
                which(nsc.adult.total.mass$Spp == "PIST"),
                which(nsc.adult.total.mass$Spp == "PIVI2"),
                which(nsc.adult.total.mass$Spp == "PIRE"),
                which(nsc.adult.total.mass$Spp == "PIRI"),
                which(nsc.adult.total.mass$Spp == "PITA")
                )
      
      Larix <- c(
                which(nsc.adult.total.mass$Spp == "LALA")
                )
      
      Picea <- c(
                which(nsc.adult.total.mass$Spp == "PIGL"),
                which(nsc.adult.total.mass$Spp == "PIMA"),
                which(nsc.adult.total.mass$Spp == "PIRU")
                )

      Abies <- c(
              which(nsc.adult.total.mass$Spp == "ABBA")
              )
      
Juniperus <- c(
              which(nsc.adult.total.mass$Spp == "JUVI")
              )

    Thuja <- c(
              which(nsc.adult.total.mass$Spp == "THOC2")
              )
    
    Tsuga <- c(
              which(nsc.adult.total.mass$Spp == "TSCA")
              )
    
    
    
    ### Set total dataframe for Genus
    
    nsc.adult.total.mass$genus <- NA
    nsc.adult.total.mass$genus[Pinus] <- "Pinus"
    nsc.adult.total.mass$genus[Larix] <- "Larix"
    nsc.adult.total.mass$genus[Picea] <- "Picea"
    nsc.adult.total.mass$genus[Abies] <- "Abies"
    nsc.adult.total.mass$genus[Thuja] <- "Thuja"
    nsc.adult.total.mass$genus[Tsuga] <- "Tsuga"
    nsc.adult.total.mass$genus[Juniperus] <- "Juniperus"
    nsc.adult.total.mass$genus[Quercus] <- "Quercus"
    nsc.adult.total.mass$genus[Fraxinus] <- "Fraxinus"
    nsc.adult.total.mass$genus[Ailanthus] <- "Ailanthus"
    nsc.adult.total.mass$genus[Robinia] <- "Robinia"
    nsc.adult.total.mass$genus[Sassafras] <- "Sassafras"
    nsc.adult.total.mass$genus[Acer] <- "Acer"
    nsc.adult.total.mass$genus[Aesculus] <- "Aesculus"
    nsc.adult.total.mass$genus[Betula] <- "Betula"
    nsc.adult.total.mass$genus[Carpinus] <- "Carpinus"
    nsc.adult.total.mass$genus[Cornus] <- "Cornus"
    nsc.adult.total.mass$genus[Liquidambar] <- "Liquidambar"
    nsc.adult.total.mass$genus[Liriodendron] <- "Liriodendron"
    nsc.adult.total.mass$genus[Magnolia] <- "Magnolia"
    nsc.adult.total.mass$genus[Platanus] <- "Platanus"
    nsc.adult.total.mass$genus[Fagus] <- "Fagus"
    nsc.adult.total.mass$genus[Nyssa] <- "Nyssa"
    nsc.adult.total.mass$genus[Oxydendrum] <- "Oxydendrum"
    nsc.adult.total.mass$genus[Tilia] <- "Tilia"
    nsc.adult.total.mass$genus[Populus] <- "Populus"
    nsc.adult.total.mass$genus[Prunus] <- "Prunus"
    nsc.adult.total.mass$genus[Carya] <- "Carya"
    nsc.adult.total.mass$genus[Cercis] <- "Cercis"
    nsc.adult.total.mass$genus[Diospyros] <- "Diospyros"
    nsc.adult.total.mass$genus[Juglans] <- "Juglans"
    nsc.adult.total.mass$genus[Ulmus] <- "Ulmus"
    
  ###Add Family
  Aceraceae <- c(
              which(nsc.adult.total.mass$genus == "Acer")
              )
  
  Betulaceae <- c(
                which(nsc.adult.total.mass$genus == "Betula"),
                which(nsc.adult.total.mass$genus == "Carpinus")
                )
  
  Cornaceae <- c(which(nsc.adult.total.mass$genus == "Cornus"),
                 which(nsc.adult.total.mass$genus == "Nyssa"))
  
  Cupressaceae <- c(which(nsc.adult.total.mass$genus == "Thuja"),
                    which(nsc.adult.total.mass$genus == "Juniperus"))
  
  Ebenaceae <- c(which(nsc.adult.total.mass$genus == "Diospyros"))
  
  Ericaceae <- c(which(nsc.adult.total.mass$genus == "Oxydendrum"))
  
  Fabaceae <- c(which(nsc.adult.total.mass$genus == "Robinia"),
                    which(nsc.adult.total.mass$genus == "Cercis"))
  
  Fagaceae <- c(which(nsc.adult.total.mass$genus == "Quercus"),
                which(nsc.adult.total.mass$genus == "Fagus"))
  
  Hamamelidaceae <- c(which(nsc.adult.total.mass$genus == "Liquidambar"))
  
  Hippocastanaceae <- c(which(nsc.adult.total.mass$genus == "Aesculus"))
  
  Juglandaceae <- c(which(nsc.adult.total.mass$genus == "Carya"),
                    which(nsc.adult.total.mass$genus == "Juglans"))
  
  Lauraceae <- c(which(nsc.adult.total.mass$genus == "Sassafras"))
  
  Magnoliaceae <- c(which(nsc.adult.total.mass$genus == "Liriodendron"),
                    which(nsc.adult.total.mass$genus == "Magnolia"))
  
  Oleaceae <- c(which(nsc.adult.total.mass$genus == "Fraxinus"))
  
  Pinaceae <- c(which(nsc.adult.total.mass$genus == "Pinus"),
                which(nsc.adult.total.mass$genus == "Larix"),
                which(nsc.adult.total.mass$genus == "Picea"),
                which(nsc.adult.total.mass$genus == "Abies"),
                which(nsc.adult.total.mass$genus == "Tsuga")
                )
  
  Platanaceae <- c(which(nsc.adult.total.mass$genus == "Platanus"))
  
  Rosaceae <- c(which(nsc.adult.total.mass$genus == "Prunus"))
  
  Salicaceae <- c(which(nsc.adult.total.mass$genus == "Populus"))
  
  Simaroubaceae <- c(which(nsc.adult.total.mass$genus == "Ailanthus"))
  
  Tiliaceae <- c(which(nsc.adult.total.mass$genus == "Tilia"))
  
  Ulmaceae <- c(which(nsc.adult.total.mass$genus == "Ulmus"))
  
  #Make single genus-species column
    nsc.adult.total.mass$GenusSpecies <- NA
    nsc.adult.total.mass$GenusSpecies <- with(nsc.adult.total.mass, paste(genus, species))
  
  #Set total dataframe for Family
  nsc.adult.total.mass$family <- NA
    nsc.adult.total.mass$family[Aceraceae] <- "Aceraceae"
    nsc.adult.total.mass$family[Betulaceae] <- "Betulaceae"       
    nsc.adult.total.mass$family[Cornaceae] <- "Cornaceae"
    nsc.adult.total.mass$family[Cupressaceae] <- "Cupressaceae"
    nsc.adult.total.mass$family[Ebenaceae] <- "Ebenaceae"
    nsc.adult.total.mass$family[Ericaceae] <- "Ericaceae"
    nsc.adult.total.mass$family[Fabaceae] <- "Fabaceae"
    nsc.adult.total.mass$family[Fagaceae] <- "Fagaceae"
    nsc.adult.total.mass$family[Hamamelidaceae] <- "Hamamelidaceae"
    nsc.adult.total.mass$family[Hippocastanaceae] <- "Hippocastanaceae"
    nsc.adult.total.mass$family[Juglandaceae] <- "Juglandaceae"
    nsc.adult.total.mass$family[Sassafras] <- "Lauraceae"
    nsc.adult.total.mass$family[Magnoliaceae] <- "Magnoliaceae"
    nsc.adult.total.mass$family[Oleaceae] <- "Oleaceae"   
    nsc.adult.total.mass$family[Pinaceae] <- "Pinaceae"
    nsc.adult.total.mass$family[Platanaceae] <- "Platanaceae"
    nsc.adult.total.mass$family[Rosaceae] <- "Rosaceae"
    nsc.adult.total.mass$family[Salicaceae] <- "Salicaceae"
    nsc.adult.total.mass$family[Simaroubaceae] <- "Simaroubaceae"
    nsc.adult.total.mass$family[Tiliaceae] <- "Tiliaceae"
    nsc.adult.total.mass$family[Ulmaceae] <- "Ulmaceae"

    #Order
    Sapindales <- c(which(nsc.adult.total.mass$family == "Aceraceae"),
                    which(nsc.adult.total.mass$family == "Hippocastanaceae"),
                    which(nsc.adult.total.mass$family == "Simaroubaceae"))
    
    Fagales <- c(which(nsc.adult.total.mass$family == "Betulaceae"),
                 which(nsc.adult.total.mass$family == "Fagaceae"))
    
    Cornales <- c(which(nsc.adult.total.mass$family == "Cornaceae"))
    
    Pinales <- c(which(nsc.adult.total.mass$family == "Cupressaceae"),
                 which(nsc.adult.total.mass$family == "Pinaceae"))
    
    Ebenales <- c(which(nsc.adult.total.mass$family == "Ebenaceae"))
    Ericales <- c(which(nsc.adult.total.mass$family == "Ericaceae"))
    Fabales <- c(which(nsc.adult.total.mass$family == "Fabaceae"))
    
    Hamamelidales <- c(which(nsc.adult.total.mass$family == "Hamamelidaceae"),
                       which(nsc.adult.total.mass$family == "Platanaceae"))
    
    Juglandales <- c(which(nsc.adult.total.mass$family == "Juglandaceae"))
    Laurales <- c(which(nsc.adult.total.mass$family == "Lauraceae"))
    Magnoliales <- c(which(nsc.adult.total.mass$family == "Magnoliaceae"))
    Scrophulariales <- c(which(nsc.adult.total.mass$family == "Oleaceae"))
    Rosales <- c(which(nsc.adult.total.mass$family == "Rosaceae"))
    Salicales <- c(which(nsc.adult.total.mass$family == "Salicaceae"))
    Malvales <- c(which(nsc.adult.total.mass$family == "Tiliaceae"))
    Urticales <- c(which(nsc.adult.total.mass$family == "Ulmaceae"))
    
    #Set total dataframe for order
    nsc.adult.total.mass$order <- NA
    nsc.adult.total.mass$order[Sapindales] <- "Sapindales"
    nsc.adult.total.mass$order[Fagales] <- "Fagales"       
    nsc.adult.total.mass$order[Cornales] <- "Cornales"
    nsc.adult.total.mass$order[Pinales] <- "Pinales"
    nsc.adult.total.mass$order[Ebenales] <- "Ebenales"
    nsc.adult.total.mass$order[Ericales] <- "Ericales"
    nsc.adult.total.mass$order[Fabales] <- "Fabales"
    nsc.adult.total.mass$order[Hamamelidales] <- "Hamamelidales"
    nsc.adult.total.mass$order[Juglandales] <- "Juglandales"
    nsc.adult.total.mass$order[Laurales] <- "Laurales"
    nsc.adult.total.mass$order[Magnoliales] <- "Magnoliales"
    nsc.adult.total.mass$order[Scrophulariales] <- "Scrophulariales"
    nsc.adult.total.mass$order[Rosales] <- "Rosales"
    nsc.adult.total.mass$order[Salicales] <- "Salicales"   
    nsc.adult.total.mass$order[Malvales] <- "Malvales"
    nsc.adult.total.mass$order[Urticales] <- "Urticales"

    #Subclass
    Rosidae <- c(which(nsc.adult.total.mass$order == "Sapindales"),
                 which(nsc.adult.total.mass$order == "Cornales"),
                 which(nsc.adult.total.mass$order == "Fabales"),
                 which(nsc.adult.total.mass$order == "Rosales"))
    
    Hamamelididae <- c(which(nsc.adult.total.mass$order == "Fagales"),
                       which(nsc.adult.total.mass$order == "Hamamelidales"),
                       which(nsc.adult.total.mass$order == "Juglandales"),
                       which(nsc.adult.total.mass$order == "Urticales"))
    
    Pinopsida <- c(which(nsc.adult.total.mass$order == "Pinales"))
    
    Dilleniidae <- c(which(nsc.adult.total.mass$order == "Ebenales"),
                     which(nsc.adult.total.mass$order == "Ericales"),
                     which(nsc.adult.total.mass$order == "Salicales"),
                     which(nsc.adult.total.mass$order == "Malvales"))
    
    Magnoliidae <- c(which(nsc.adult.total.mass$order == "Magnoliales"),
                     which(nsc.adult.total.mass$order == "Laurales"))
    
    Asteridae <- c(which(nsc.adult.total.mass$order == "Scrophulariales"))
    
        #Set total dataframe for Subclass
    nsc.adult.total.mass$subclass <- NA
    nsc.adult.total.mass$subclass[Rosidae] <- "Rosidae"
    nsc.adult.total.mass$subclass[Hamamelididae] <- "Hamamelididae"       
    nsc.adult.total.mass$subclass[Pinopsida] <- "Pinopsida"
    nsc.adult.total.mass$subclass[Dilleniidae] <- "Dilleniidae"
    nsc.adult.total.mass$subclass[Magnoliidae] <- "Magnoliidae"
    nsc.adult.total.mass$subclass[Asteridae] <- "Asteridae"

    
#only hardwood dataframe
early.h <- which(nsc.adult.total.mass$PFT == "Early.Hardwood")
mid.h <- which(nsc.adult.total.mass$PFT == "Mid.Hardwood")
late.h <- which(nsc.adult.total.mass$PFT == "Late.Hardwood")

nsc.adult.total.mass.hard <- rbind(
                             nsc.adult.total.mass[early.h,],
                             nsc.adult.total.mass[mid.h,],
                             nsc.adult.total.mass[late.h,]
                             )
#drop unused hardwood factor levels
# nsc.adult.total.mass.hard$Spp <- droplevels(nsc.adult.total.mass.hard$Spp)
# nsc.adult.total.mass.hard$PFT <- droplevels(nsc.adult.total.mass.hard$PFT)

nsc.adult.total.mass.hard$Spp <- as.character(nsc.adult.total.mass.hard$Spp)

nsc.adult.total.mass.hard$Spp <- factor(nsc.adult.total.mass.hard$Spp, 
                  levels = c("ACPE","AIAL","BEAL2","BELE",
                  "BEPA","BETUL","JUCI","JUNI","LIST2","LITU","POGR4","POTR5",
                  "PRSE2","ROPS","SAAL5","FRAM2","FRNI","FRQU","ACNE2",
                  "ACRU","CACA18","CACO15","CAGL8","CALA21","CAOV2",
                  "CATO6","CECA4","MAAC","MAFR","QUAL","QUCO2","QUIM",
                  "QUMO4","QUMU","QUPH","QURU","QUVE","QUVI","ULAM","ACFL",
                  "ACSA3","AEGL","FAGR","NYSY","OXAR","TIAM"), ordered = TRUE)

#levels(nsc.adult.total.mass.hard$Spp)
#levels(nsc.adult.total.mass.hard$PFT) <- c("Early.Hardwood","Mid.Hardwood","Late.Hardwood")
#levels(nsc.adult.total.mass.hard$PFT)

#nsc.adult.total.mass.hard <- nsc.adult.total.mass.hard[order(nsc.adult.total.mass.hard$Spp),]
#nsc.adult.total.mass.hard <- nsc.adult.total.mass.hard[order(nsc.adult.total.mass.hard$PFT),]

#only conifer dataframe
early.c <- which(nsc.adult.total.mass$PFT == "Early.Conifer")
late.c <- which(nsc.adult.total.mass$PFT == "Late.Conifer")

nsc.adult.total.mass.conif <- rbind(
  nsc.adult.total.mass[early.c,],
  nsc.adult.total.mass[late.c,]
)

#drop unused conifer factors
# nsc.adult.total.mass.conif$Spp <- droplevels(nsc.adult.total.mass.conif$Spp)
# nsc.adult.total.mass.conif$PFT <- droplevels(nsc.adult.total.mass.conif$PFT)

nsc.adult.total.mass.conif$Spp <- as.character(nsc.adult.total.mass.conif$Spp)

#relevel factors
nsc.adult.total.mass.conif$Spp <- factor(nsc.adult.total.mass.conif$Spp, 
                              levels = c("ABBA","JUVI","PIPA2","PIST","PIVI2","PIRE",
                                         "PIRI","PITA","LALA","PIGL","PIMA","PIRU",
                                         "THOC2","TSCA"), ordered = TRUE)

#Include only alive and IBS individuals, no dead trees
alive.total <- which(nsc.adult.total.mass$Mortality14 == "A")
stress.total <- which(nsc.adult.total.mass$Mortality14 == "IBS")

nsc.adult.total.mass.alive <- rbind(
                             nsc.adult.total.mass[alive.total,],
                             nsc.adult.total.mass[stress.total,]
                             )

count(nsc.adult.total.mass.alive$Spp)
#remove spp with very low sample size, setting cutoff below 5 because
#of an arbitrary reason, need to do an actual power analysis

abba <- which(nsc.adult.total.mass.alive$Spp == "ABBA")
acne2 <- which(nsc.adult.total.mass.alive$Spp == "ACNE2")
acru <- which(nsc.adult.total.mass.alive$Spp == "ACRU")
acsa3 <- which(nsc.adult.total.mass.alive$Spp == "ACSA3")
beal2 <- which(nsc.adult.total.mass.alive$Spp == "BEAL2")
bele <- which(nsc.adult.total.mass.alive$Spp == "BELE")
bepa <- which(nsc.adult.total.mass.alive$Spp == "BEPA")
caco15 <- which(nsc.adult.total.mass.alive$Spp == "CACO15")
cagl8 <- which(nsc.adult.total.mass.alive$Spp == "CAGL8")
caov2 <- which(nsc.adult.total.mass.alive$Spp == "CAOV2")
cato6 <- which(nsc.adult.total.mass.alive$Spp == "CATO6")
fagr <- which(nsc.adult.total.mass.alive$Spp == "FAGR")
fram2 <- which(nsc.adult.total.mass.alive$Spp == "FRAM2")
frni <- which(nsc.adult.total.mass.alive$Spp == "FRNI")
juni <- which(nsc.adult.total.mass.alive$Spp == "JUNI")
juvi <- which(nsc.adult.total.mass.alive$Spp == "JUVI")
list2 <- which(nsc.adult.total.mass.alive$Spp == "LIST2")
litu <- which(nsc.adult.total.mass.alive$Spp == "LITU")
mavi2 <- which(nsc.adult.total.mass.alive$Spp == "MAVI2")
nysy <- which(nsc.adult.total.mass.alive$Spp == "NYSY")
oxar <- which(nsc.adult.total.mass.alive$Spp == "OXAR")
pima <- which(nsc.adult.total.mass.alive$Spp == "PIMA")
pipa2 <- which(nsc.adult.total.mass.alive$Spp == "PIPA2")
piri <- which(nsc.adult.total.mass.alive$Spp == "PIRI")
piru <- which(nsc.adult.total.mass.alive$Spp == "PIRU")
pist <- which(nsc.adult.total.mass.alive$Spp == "PIST")
pita <- which(nsc.adult.total.mass.alive$Spp == "PITA")
pogr4 <- which(nsc.adult.total.mass.alive$Spp == "POGR4")
potr5 <- which(nsc.adult.total.mass.alive$Spp == "POTR5")
prse2 <- which(nsc.adult.total.mass.alive$Spp == "PRSE2")
qual <- which(nsc.adult.total.mass.alive$Spp == "QUAL")
qula2 <- which(nsc.adult.total.mass.alive$Spp == "QULA2")
qula3 <- which(nsc.adult.total.mass.alive$Spp == "QULA3")
qumo4 <- which(nsc.adult.total.mass.alive$Spp == "QUMO4")
qumu <- which(nsc.adult.total.mass.alive$Spp == "QUMU")
quni <- which(nsc.adult.total.mass.alive$Spp == "QUNI")
quph <- which(nsc.adult.total.mass.alive$Spp == "QUPH")
quru <- which(nsc.adult.total.mass.alive$Spp == "QURU")
quve <- which(nsc.adult.total.mass.alive$Spp == "QUVE")
quvi <- which(nsc.adult.total.mass.alive$Spp == "QUVI")
saal5 <- which(nsc.adult.total.mass.alive$Spp == "SAAL5")
thoc2 <- which(nsc.adult.total.mass.alive$Spp == "THOC2")
tiam <- which(nsc.adult.total.mass.alive$Spp == "TIAM")
tsca <- which(nsc.adult.total.mass.alive$Spp == "TSCA")
ulam <- which(nsc.adult.total.mass.alive$Spp == "ULAM")

nsc.adult.total.mass.alive.common <- rbind(
                             nsc.adult.total.mass.alive[abba,],
                             nsc.adult.total.mass.alive[acne2,],
                             nsc.adult.total.mass.alive[acru,],
                             nsc.adult.total.mass.alive[acsa3,],
                             nsc.adult.total.mass.alive[beal2,],
                             nsc.adult.total.mass.alive[bele,],
                             nsc.adult.total.mass.alive[bepa,],
                             nsc.adult.total.mass.alive[caco15,],
                             nsc.adult.total.mass.alive[cagl8,],
                             nsc.adult.total.mass.alive[caov2,],
                             nsc.adult.total.mass.alive[cato6,],
                             nsc.adult.total.mass.alive[fagr,],
                             nsc.adult.total.mass.alive[fram2,],
                             nsc.adult.total.mass.alive[frni,],
                             nsc.adult.total.mass.alive[juni,],
                             nsc.adult.total.mass.alive[juvi,],
                             nsc.adult.total.mass.alive[list2,],
                             nsc.adult.total.mass.alive[litu,],
                             nsc.adult.total.mass.alive[mavi2,],
                             nsc.adult.total.mass.alive[nysy,],
                             nsc.adult.total.mass.alive[oxar,],
                             nsc.adult.total.mass.alive[pima,],
                             nsc.adult.total.mass.alive[pipa2,],
                             nsc.adult.total.mass.alive[piri,],
                             nsc.adult.total.mass.alive[piru,],
                             nsc.adult.total.mass.alive[pist,],
                             nsc.adult.total.mass.alive[pita,],
                             nsc.adult.total.mass.alive[pogr4,],
                             nsc.adult.total.mass.alive[potr5,],
                             nsc.adult.total.mass.alive[prse2,],
                             nsc.adult.total.mass.alive[qual,],
                             nsc.adult.total.mass.alive[qula2,],
                             nsc.adult.total.mass.alive[qula3,],
                             nsc.adult.total.mass.alive[qumo4,],
                             nsc.adult.total.mass.alive[qumu,],
                             nsc.adult.total.mass.alive[quni,],
                             nsc.adult.total.mass.alive[quph,],
                             nsc.adult.total.mass.alive[quru,],
                             nsc.adult.total.mass.alive[quve,],
                             nsc.adult.total.mass.alive[quvi,],
                             nsc.adult.total.mass.alive[saal5,],
                             nsc.adult.total.mass.alive[thoc2,],
                             nsc.adult.total.mass.alive[tiam,],
                             nsc.adult.total.mass.alive[tsca,],
                             nsc.adult.total.mass.alive[ulam,])

write.csv(x = nsc.adult.total.mass.alive.common, file = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Data/nsc.adult.total.mass.alive.common.csv")

nsc.adult.total.mass.alive.common$GenusSpecies <- factor(nsc.adult.total.mass.alive.common$GenusSpecies, 
                  levels = c("Juniperus virginiana","Thuja occidentalis","Abies balsamea","Tsuga canadensis","Picea mariana", "Picea rubens","Pinus strobus","Pinus palustris","Pinus taeda","Pinus rigida","Sassafras albidum","Magnolia virginiana","Liriodendron tulipifera","Liquidambar styraciflua","Oxydendrum arboreum","Nyssa sylvatica","Fraxinus americana","Fraxinus nigra","Tilia americana","Acer rubrum","Acer saccharum","Acer negundo","Populus grandidentata","Populus tremuloides","Prunus serotina","Ulmus americana","Betula lenta","Betula papyrifera","Betula alleghaniensis","Juglans nigra","Carya glabra","Carya cordiformis","Carya ovata","Carya tomentosa","Fagus grandifolia","Quercus laurifolia","Quercus alba","Quercus velutina","Quercus nigra","Quercus laevis","Quercus montana","Quercus rubra","Quercus virginiana","Quercus muehlenbergii","Quercus phellos"), ordered = TRUE)

nsc.adult.total.mass.alive.common$wood <- factor(nsc.adult.total.mass.alive.common$wood, levels = c("large.resin","small.resin", "no.resin","ring.porous","semiring.porous","diffuse.porous"), ordered = TRUE)

nsc.adult.total.mass.alive.common$PFT <- factor(nsc.adult.total.mass.alive.common$PFT, levels = c("Early.Conifer","Late.Conifer","Early.Hardwood","Mid.Hardwood","Late.Hardwood"), ordered = TRUE)

# read.nexus(file = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Data/NSCnexus.txt")
# read.newick(file = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Data/NSCnewick.txt")
# read.tree(text = phylotree)
# collapse.singles(phylotree)
# read.tree(file = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Data/kpFZcV9XjpZp8D4oS-HXxQ_newick.txt")

```

Everything before this is preprocessing of data.
Phylogenetics Exploratory Analyses - ANOVA based

```{r}
#Species Anova
lm.species.total <- lm(total.nsc ~ GenusSpecies, data = nsc.adult.total.mass.alive.common)
anova(lm.species.total)
summary(lm.species.total) #R^2 = .5877

#TukeyHSD species
#too many groups, not good to visualize
# summary(aov.species <- aov(lm.species.total))
# tukey.species <- TukeyHSD(aov.species, "GenusSpecies", ordered = FALSE)
# plot(tukey.species)
# species.levels <- tukey.species[["GenusSpecies"]][,4]
# species.labels <- multcompLetters(species.levels)['Letters']
# species.plot.labels <- names(species.labels[['Letters']])

#Species boxplot
nsc.species <- ggplot(nsc.adult.total.mass.alive.common, aes(x = GenusSpecies, y = total.nsc, fill = wood)) + 
  geom_boxplot() + theme(axis.text.x = element_text(angle=90,hjust=1,vjust=.5,size=10)) +
  theme(axis.text.y = element_text(size=12)) +
  #theme(axis.title.x = element_text(size=16)) +
  theme(axis.title.y = element_text(size=14)) +
  theme(legend.text = element_text(size=10)) + 
  theme(legend.title = element_text(size = 14)) +
  theme(legend.key.size = unit(.4, "cm")) +
  labs(fill = "Wood\nAnatomy") +
  stat_summary(fun.data = give.n, geom= "text", size = 2.5, aes(y= 160)) + 
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("") + ggtitle("All Species") +
  scale_fill_manual(values=rev(cbPalette), labels = c("Large Resin", "Small Resin", "No Resin", "Ring Porous", "Semi-ring\nPorous", "Diffuse Porous"))

ggsave(filename = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Figures/TotalNSC.AllCommonSpp.png", plot = nsc.species, dpi = 600, width = 10, height = 4.75, units = "in")

#Genus anova
lm.genus.total <- lm(total.nsc ~ genus, data = nsc.adult.total.mass.alive.common)
anova(lm.genus.total)
summary(lm.genus.total) #R^2 = .5464

#Genus ggplot boxplot
ggplot(nsc.adult.total.mass.alive.common, aes(x = genus, y = total.nsc, fill = wood)) + #not enough colors for genus fill
  geom_boxplot() + theme(axis.text.x = element_text(angle=90,hjust=1,size=12)) +
  theme(axis.text.y = element_text(size=16)) +
  theme(axis.title.x = element_text(size=20)) +
  theme(axis.title.y = element_text(size=20)) +
  theme(legend.text = element_text(size=16)) +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 160)) + 
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Genus") + ggtitle("All Genera") +
#   geom_segment(aes(x=0,y=med.early.conif,xend=7.5,
#                    yend=med.early.conif),linetype="longdash",color="indianred4") +
#   geom_segment(aes(x=7.5,y=med.late.conif,xend=12,
#                    yend=med.late.conif),linetype="longdash",color="darkgreen") +
  scale_fill_manual(values=rev(cbPalette))

#Family anova
lm.family.total <- lm(total.nsc ~ family, data = nsc.adult.total.mass.alive.common)
anova(lm.family.total)
summary(lm.family.total) #R^2 = .523

#Family ggplot boxplot
ggplot(nsc.adult.total.mass.alive.common, aes(x = family, y = total.nsc, fill = "red")) + #need more colors for fill based on family
  geom_boxplot() + theme(axis.text.x = element_text(angle=45,hjust=1,size=12)) +
  theme(axis.text.y = element_text(size=16)) +
  theme(axis.title.x = element_text(size=20)) +
  theme(axis.title.y = element_text(size=20)) +
  theme(legend.text = element_text(size=16)) +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 160)) + 
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Family") + ggtitle("All Families") +
#   geom_segment(aes(x=0,y=med.early.conif,xend=7.5,
#                    yend=med.early.conif),linetype="longdash",color="indianred4") +
#   geom_segment(aes(x=7.5,y=med.late.conif,xend=12,
#                    yend=med.late.conif),linetype="longdash",color="darkgreen") +
  scale_fill_manual(values=rev(cbPalette))

#Order ANOVA
lm.order.total <- lm(total.nsc ~ order, data = nsc.adult.total.mass.alive.common)
anova(lm.order.total)
summary(lm.order.total) #R^2 = .411

#Order ggplot, can also make violin plot
ggplot(nsc.adult.total.mass.alive.common, aes(x = order, y = total.nsc, fill = "red")) + #need more colors for fill based on order
  geom_boxplot() + theme(axis.text.x = element_text(angle=45,hjust=1,size=12)) +
  theme(axis.text.y = element_text(size=16)) +
  theme(axis.title.x = element_text(size=20)) +
  theme(axis.title.y = element_text(size=20)) +
  theme(legend.text = element_text(size=16)) +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 160)) + 
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Order") + ggtitle("All Orders") +
#   geom_segment(aes(x=0,y=med.early.conif,xend=7.5,
#                    yend=med.early.conif),linetype="longdash",color="indianred4") +
#   geom_segment(aes(x=7.5,y=med.late.conif,xend=12,
#                    yend=med.late.conif),linetype="longdash",color="darkgreen") +
  scale_fill_manual(values=rev(cbPalette))

#Subclass ANOVA
lm.subclass.total <- lm(total.nsc ~ subclass, data = nsc.adult.total.mass.alive.common)
anova(lm.subclass.total)
summary(lm.subclass.total) #R^2 = .3771

#Subclass ggplot, can also make violin plot
ggplot(nsc.adult.total.mass.alive.common, aes(x = subclass, y = total.nsc, fill = "red")) + #need more colors for fill based on order
  geom_violin() + theme(axis.text.x = element_text(angle=45,hjust=1,size=12)) +
  theme(axis.text.y = element_text(size=16)) +
  theme(axis.title.x = element_text(size=20)) +
  theme(axis.title.y = element_text(size=20)) +
  theme(legend.text = element_text(size=16)) +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 160)) + 
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Subclass") + ggtitle("All Subclasses") +
#   geom_segment(aes(x=0,y=med.early.conif,xend=7.5,
#                    yend=med.early.conif),linetype="longdash",color="indianred4") +
#   geom_segment(aes(x=7.5,y=med.late.conif,xend=12,
#                    yend=med.late.conif),linetype="longdash",color="darkgreen") +
  scale_fill_manual(values=rev(cbPalette))


#PFT anova
lm.pft.total <- lm(total.nsc ~ PFT, data = nsc.adult.total.mass.alive.common)
anova(lm.pft.total)
summary(lm.pft.total) #R^2 = .363

#TukeyHSD PFT
summary(aov.pft <- aov(lm.pft.total))
tukey.pft <- TukeyHSD(aov.pft, "PFT", ordered = FALSE)
plot(tukey.pft)
pft.levels <- tukey.pft[["PFT"]][,4]
pft.labels <- multcompLetters(pft.levels)['Letters']
pft.plot.labels <- names(pft.labels[['Letters']])

#PFT ggplot 
pft.violin <- ggplot(nsc.adult.total.mass.alive.common, aes(x = PFT, y = total.nsc)) + #, fill = PFT
  geom_violin() + theme(axis.text.x = element_text(angle=45,hjust=1,size=16)) +
  theme(axis.text.y = element_text(size=12)) +
  theme(axis.title.x = element_text(size=14)) +
  theme(axis.title.y = element_text(size=14)) +
  theme(axis.text.x = element_text(size=12)) +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 205)) + 
  stat_summary(fun.y="median", geom="point") +
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Plant Functional Type") +
  annotate("text", x = 1:5, y = c(110, 95, 165, 185, 135), 
           label = c("e","a","b","c","d"))


ggsave(filename = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Figures/TotalNSC.AllCommonPFT.png", plot = pft.violin, dpi = 600, width = 7.5, height = 3.5, units = "in")

#wood anatomy anova
lm.wood.total <- lm(total.nsc ~ wood, data = nsc.adult.total.mass.alive.common)
anova(lm.wood.total)
summary(lm.wood.total) #R^2 = .4266

#TukeyHSD wood anatomy
summary(aov.wood <- aov(lm.wood.total))
tukey.wood <- TukeyHSD(aov.wood, "wood", ordered = FALSE)
plot(tukey.wood)
wood.levels <- tukey.wood[["wood"]][,4]
wood.labels <- multcompLetters(wood.levels)['Letters']
wood.plot.labels <- names(wood.labels[['Letters']])

#Wood anatomy ggplot boxplot
wood.anatomy.nsc <- ggplot(nsc.adult.total.mass.alive.common, aes(x = wood, y = total.nsc, fill = wood)) +
  geom_violin() + theme(axis.text.x = element_text(angle=45,hjust=1,size=16)) +
  theme(axis.text.y = element_text(size=12)) +
  theme(axis.title.x = element_text(size=14)) +
  theme(axis.title.y = element_text(size=14)) +
  theme(axis.text.x = element_text(size = 12)) +
  theme(legend.text = element_blank()) +
  theme(legend.position = "none") +
  stat_summary(fun.data = give.n, geom= "text", size = 3.5, aes(y= 200)) + 
  stat_summary(fun.y="median", geom="point") +
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Wood Anatomy") + #ggtitle("All Wood Types") +
  scale_x_discrete(labels = c("Large Resin", "Small Resin", "No Resin", "Ring Porous", "Semi-ring Porous", "Diffuse Porous")) +
  scale_fill_manual(values=rev(cbPalette)) +
  annotate("text", x = 1:6, y = c(110, 95, 72, 165, 185, 135), label = c("b","ab","a","c","c","d"))
  #geom_text(data = wood.plot.labels)

ggsave(filename = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Figures/TotalNSC.AllCommonWoodAnat.png", plot = wood.anatomy.nsc, dpi = 600, width = 7.5, height = 3.5, units = "in")



###Anovas for hierarchical and individual effects
fit.total.nsc.nested = aov(total.nsc ~ Site/Plot/Sub, 
                 data = nsc.adult.total.mass.alive.common)
summary(fit.total.nsc.nested)
var.total.nsc.nested = anova(fit.total.nsc.nested)[,2]
prop.var.total.nsc.nested = var.total.nsc.nested/sum(var.total.nsc.nested)

#Kitchen sink: phylogenetics fit independently
nsc.kitchen.lm <- lmer(total.nsc ~ DBH14 + Canopy15 + (1|Site) + (1|Site:GenusSpecies) + (1|GenusSpecies) + (1|genus) + (1|family) + (1|order) + (1|subclass) + (1|PFT) + (1|wood), nsc.adult.total.mass.alive.common)
summary(nsc.kitchen.lm)
plot((nsc.kitchen.lm))

#phylo emphasis
nsc.phylo.lm <- lmer(total.nsc ~ DBH14 + Canopy15 + (1|Site/Plot/Sub) + (1|subclass/order/family/genus/GenusSpecies) + (1|PFT) + (1|wood), nsc.adult.total.mass.alive.common)
summary(nsc.phylo.lm)
#str(nsc.phylo.lm)
plot((nsc.phylo.lm))

#variances
#vcov = variances of random effects
phylo.vars <- as.data.frame(VarCorr(nsc.phylo.lm, order = "cov.last"))
#calculating partial variances for random effects
var.phylo.vars = phylo.vars$vcov/sum(phylo.vars$vcov)
part.vars <- cbind(phylo.vars$grp,var.phylo.vars)
#test
sum(as.numeric(part.vars[,2]))
#now have proportions of variance explained by each effect
#Environment
#1,2,7
site.partvar <- sum(as.numeric(part.vars[1,2]),as.numeric(part.vars[2,2]),as.numeric(part.vars[7,2])) #sub, plot, site 11.88 %

#include site x spp interaction
nsc.phylo.int.lm <- lmer(total.nsc ~ DBH14 + Canopy15 + (1|Site/Plot/Sub) + (1|subclass/order/family/genus/GenusSpecies) + (1|PFT) + (1|wood) + (1|GenusSpecies:Site), nsc.adult.total.mass.alive.common)
summary(nsc.phylo.int.lm)
plot((nsc.phylo.int.lm))

#variances
#vcov = variances of random effects
phylo.vars.int <- as.data.frame(VarCorr(nsc.phylo.int.lm, order = "cov.last"))
#calculating partial variances for random effects
var.phylo.vars.int = phylo.vars.int$vcov/sum(phylo.vars.int$vcov)
part.vars.int <- cbind(phylo.vars.int$grp,var.phylo.vars.int)

#file for table of mixed effects model partial variances
write.csv(x = part.vars.int, file = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Figures/part.variances.csv")
#test
sum(as.numeric(part.vars.int[,2]))
#now have proportions of variance explained by each effect
#Environment
#1,2,7
site.partvar.int <- sum(as.numeric(part.vars.int[1,2]),as.numeric(part.vars.int[3,2]),as.numeric(part.vars.int[8,2])) #sub, plot, site 11.875%

trait.partvar.int <- sum(as.numeric(part.vars.int[9,2]),as.numeric(part.vars.int[11,2])) #pft & wood .5%

Phylo.partvar.int <- sum(as.numeric(part.vars.int[4,2]),as.numeric(part.vars.int[5,2]),as.numeric(part.vars.int[6,2]),as.numeric(part.vars.int[7,2]),as.numeric(part.vars.int[10,2])) #species, genus, family, order, subclass, 45.08%, family & order alone: 38.3

#Species * Site interaction: 6.2%

#Everything - residual
all.partvar.int <- sum(as.numeric(part.vars.int[,2])) - as.numeric(part.vars.int[12,2])
#63.6%




# total.var <- sum(52.68, 93.72, 207.88, 67.34, 36.01, 282.80)
# phylo.vars <- sum(52.68, 93.72, 207.88,36.01)
# phylo <- phylo.vars/total.var

# total.var <- sum(57.37, 3.002, 167.924, 169.875, 70.315, 10.25, 282.812)
# phylo.var <- sum(57.37, 3.002, 167.924, 169.875, 10.25)
# phylo.tot <- phylo.var/total.var
 
 # (Intercept)  57.370   7.574  
 # (Intercept)   3.002   1.733  
 # (Intercept) 167.924  12.959  
 # (Intercept) 169.875  13.034  
 # (Intercept)  70.315   8.385  
 # (Intercept)  10.250   3.201  
 #             282.812  16.817  

nsc.trait.lm <- lmer(total.nsc ~ DBH14 + Canopy15 + (1|Site) + (1|PFT) + (1|wood), nsc.adult.total.mass.alive.common)
summary(nsc.trait.lm)
plot((nsc.trait.lm))


```

Canopy Status and Mortality

```{r}
#Canopy Status
nsc.adult.total.mass.alive.common$Canopy15 <- as.factor(nsc.adult.total.mass.alive.common$Canopy15)
lm.canopy.total <- lm(total.nsc ~ Canopy15, data = nsc.adult.total.mass.alive.common)
anova(lm.canopy.total)
summary(lm.canopy.total)

#Canopy Tukey HSD
summary(aov.canopy <- aov(lm.canopy.total))
tukey.canopy <- TukeyHSD(aov.canopy, "Canopy15", ordered = FALSE)
plot(tukey.canopy)
canopy.levels <- tukey.canopy[["Canopy15"]][,4]
canopy.labels <- multcompLetters(canopy.levels)['Letters']
canopy.plot.labels <- names(canopy.labels[['Letters']])

canopy.nsc <- ggplot(nsc.adult.total.mass.alive.common[!is.na(nsc.adult.total.mass.alive.common$Canopy15),], aes(x = Canopy15, y = total.nsc)) +
  geom_violin() + theme(axis.text.x = element_text(angle=0,hjust=.5,vjust = .5, size=8)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  stat_summary(fun.y="median", geom="point") +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 198)) + 
  scale_x_discrete(labels = c("Understory", "Co-dominant", "Dominant")) +
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Canopy Status") +
  annotate("text", x = 1:3, y = c(136, 155, 180), label = c("c","a","b")) +
  ggtitle("All Species")


ggsave(filename = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Figures/TotalNSC.AllCommonCanopy.png", plot = canopy.nsc, dpi = 600, width = 6.5, height = 3, units = "in")

lm.can <- lm(total.nsc ~ Canopy15, data = nsc.adult.total.mass.alive.common)
anova(lm.can)
summary(lm.can)

#DBH
dbh.nsc <- ggplot(nsc.adult.total.mass.alive.common, aes(x = DBH14, y = total.nsc)) +
  geom_point(alpha = .3) +
  geom_smooth(method = "gam", formula = y ~ s(x), size = 1, aes(color = "blue")) + # GAM model with smooth
  geom_smooth(method = "lm", aes(color = "yellow")) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  scale_color_manual(name = "Fit", values = c("blue","yellow"), labels = c("GAM smooth", "linear")) + 
  theme(legend.position = "none") +
  ggtitle("All Species")

ggsave(filename = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Figures/TotalNSC.AllCommon.DBH.png", plot = dbh.nsc, dpi = 600, width = 5, height = 3.5, units = "in")

lm.dbh <- lm(total.nsc ~ DBH14, data = nsc.adult.total.mass.alive.common)
anova(lm.dbh)
summary(lm.dbh)


###DBH and Canopy Analysis for most common species
#Quercus dataframe
quercus.sort <- which(nsc.adult.total.mass.alive.common$genus == "Quercus")
nsc.adult.quercus <- nsc.adult.total.mass.alive.common[quercus.sort,]

#DBH quercus
dbh.nsc.quercus <- ggplot(nsc.adult.quercus, aes(x = DBH14, y = total.nsc)) +
  geom_point(alpha = .3) +
  geom_smooth() + #loess
  #geom_smooth(method = "gam", formula = y ~ s(x), size = 1) + # GAM model with smooth
  geom_smooth(method = "lm", col = "yellow") +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  ggtitle("Quercus")

#lm for Quercus DBH:NSC
lm.dbh.querc <- lm(total.nsc ~ DBH14, data = nsc.adult.quercus)
anova(lm.dbh.querc)
summary(lm.dbh.querc)

#lm for Canopy:NSC
lm.can.querc <- lm(total.nsc ~ Canopy15, data = nsc.adult.quercus)
anova(lm.can.querc)
summary(lm.can.querc)

#TukeyHSD
summary(aov.can.querc <- aov(lm.can.querc))
tukey.can.querc <- TukeyHSD(aov.can.querc, "Canopy15", ordered = FALSE)
plot(tukey.can.querc)
canopy.levels.querc <- tukey.can.querc[["Canopy15"]][,4]
canopy.labels.querc <- multcompLetters(canopy.levels.querc)['Letters']
canopy.plot.labels.querc <- names(canopy.labels.querc[['Letters']])

#Canopy quercus
canopy.nsc.quercus <- ggplot(nsc.adult.quercus[!is.na(nsc.adult.quercus$Canopy15),], aes(x = as.factor(Canopy15), y = total.nsc)) +
  geom_violin() + theme(axis.text.x = element_text(angle=0,hjust=.5,vjust = .5, size=8)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  stat_summary(fun.y="median", geom="point") +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 170)) + 
  scale_x_discrete(labels = c("Understory", "Co-dominant", "Dominant")) +
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Canopy Status") +
  annotate("text", x = 1:3, y = c(136, 155, 151), label = c("c","a","b")) +
  ggtitle("Quercus")
  
#FAGR dataframe
fagus.sort <- which(nsc.adult.total.mass.alive.common$genus == "Fagus")
nsc.adult.fagus <- nsc.adult.total.mass.alive.common[fagus.sort,]

#DBH fagus
dbh.nsc.fagus <- ggplot(nsc.adult.fagus, aes(x = DBH14, y = total.nsc)) +
  geom_point(alpha = .3) +
  geom_smooth() +
  #geom_smooth(method = "gam", formula = y ~ s(x), size = 1) + # GAM model with smooth
  geom_smooth(method = "lm", col = "yellow") +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  ggtitle("Fagus grandifolia")

lm.dbh.fagus <- lm(total.nsc ~ DBH14, data = nsc.adult.fagus)
anova(lm.dbh.fagus)
summary(lm.dbh.fagus)

#lm for Canopy:NSC
lm.can.fagus <- lm(total.nsc ~ Canopy15, data = nsc.adult.fagus)
anova(lm.can.fagus)
summary(lm.can.fagus)

summary(aov.can.fagus <- aov(lm.can.fagus))
tukey.can.fagus <- TukeyHSD(aov.can.fagus, "Canopy15", ordered = FALSE)
plot(tukey.can.fagus)
canopy.levels.fagus <- tukey.can.fagus[["Canopy15"]][,4]
canopy.labels.fagus <- multcompLetters(canopy.levels.fagus)['Letters']
canopy.plot.labels.fagus <- names(canopy.labels.fagus[['Letters']])

#Canopy Fagus
canopy.nsc.fagus <- ggplot(nsc.adult.fagus[!is.na(nsc.adult.fagus$Canopy15),], aes(x = as.factor(Canopy15), y = total.nsc)) +
  geom_violin() + theme(axis.text.x = element_text(angle=0,hjust=.5,vjust = .5, size=8)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  stat_summary(fun.y="median", geom="point") +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 170)) + 
  scale_x_discrete(labels = c("Understory", "Co-dominant", "Dominant")) +
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Canopy Status") +
    annotate("text", x = 1:3, y = c(122, 126, 93), label = c("a","a","a")) +
  ggtitle("Fagus grandifolia")


#TSCA dataframe
tsuga.sort <- which(nsc.adult.total.mass.alive.common$genus == "Tsuga")
nsc.adult.tsuga <- nsc.adult.total.mass.alive.common[tsuga.sort,]

dbh.nsc.tsuga <- ggplot(nsc.adult.tsuga, aes(x = DBH14, y = total.nsc)) +
  geom_point(alpha = .3) +
  geom_smooth() +
  #geom_smooth(method = "gam", formula = y ~ s(x), size = 1) + # GAM model with smooth
  geom_smooth(method = "lm", col = "yellow") +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  ggtitle("Tsuga canadensis")

lm.dbh.tsuga <- lm(total.nsc ~ DBH14, data = nsc.adult.tsuga)
anova(lm.dbh.tsuga)
summary(lm.dbh.tsuga)

#Canopy Tsuga
#lm for Canopy:NSC
lm.can.tsuga <- lm(total.nsc ~ Canopy15, data = nsc.adult.tsuga)
anova(lm.can.tsuga)
summary(lm.can.tsuga)

#only understory and co-dominant. so doing t-test for groups
t.test(total.nsc ~ Canopy15, data = nsc.adult.tsuga)

canopy.nsc.tsuga <- ggplot(nsc.adult.tsuga[!is.na(nsc.adult.tsuga$Canopy15),], aes(x = as.factor(Canopy15), y = total.nsc)) +
  geom_violin() + theme(axis.text.x = element_text(angle=0,hjust=.5,vjust = .5, size=8)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  stat_summary(fun.y="median", geom="point") +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 65)) + 
  scale_x_discrete(labels = c("Understory", "Co-dominant", "Dominant")) +
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Canopy Status") +
  annotate("text", x = 1:2, y = c(59, 47), label = c("a","b")) +
  ggtitle("Tsuga canadensis")

#ACRU dataframe
acru.sort <- which(nsc.adult.total.mass.alive.common$GenusSpecies == "Acer rubrum")
nsc.adult.acru <- nsc.adult.total.mass.alive.common[acru.sort,]

#DBH ACRU
dbh.nsc.acru <- ggplot(nsc.adult.acru, aes(x = DBH14, y = total.nsc)) +
  geom_point(alpha = .3) +
  geom_smooth() + # GAM model
  xlab("DBH") + ylab(expression(paste("Total NSC (mg g"^"-1",")"))) +
  theme(axis.text.x = element_text(size = 14))

canopy.nsc.acru <- ggplot(nsc.adult.acru[!is.na(nsc.adult.acru$Canopy15),], aes(x = as.factor(Canopy15), y = total.nsc)) +
  geom_boxplot() + theme(axis.text.x = element_text(angle=0,hjust=.5,vjust = .5, size=16)) +
  theme(axis.text.y = element_text(size=12)) +
  theme(axis.title.x = element_text(size=14)) +
  theme(axis.title.y = element_text(size=14)) +
  theme(axis.text.x = element_text(size=12)) +
  stat_summary(fun.y="median", geom="point") +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 180)) + 
  scale_x_discrete(labels = c("Understory", "Co-dominant", "Dominant")) +
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Canopy Status") # + ggtitle("All Canopy Statuses") +
  #scale_fill_manual(values=rev(cbPalette))

#ACSA3 dataframe
acsa.sort <- which(nsc.adult.total.mass.alive.common$GenusSpecies == "Acer saccharum")
nsc.adult.acsa <- nsc.adult.total.mass.alive.common[acsa.sort,]

#DBH ACSA3
dbh.nsc.acsa <- ggplot(nsc.adult.acsa, aes(x = DBH14, y = total.nsc)) +
  geom_point(alpha = .3) +
  geom_smooth() + # GAM model
  xlab("DBH") + ylab(expression(paste("Total NSC (mg g"^"-1",")"))) +
  theme(axis.text.x = element_text(size = 14))

canopy.nsc.acsa <- ggplot(nsc.adult.acsa[!is.na(nsc.adult.acsa$Canopy15),], aes(x = as.factor(Canopy15), y = total.nsc)) +
  geom_boxplot() + theme(axis.text.x = element_text(angle=0,hjust=.5,vjust = .5, size=16)) +
  theme(axis.text.y = element_text(size=12)) +
  theme(axis.title.x = element_text(size=14)) +
  theme(axis.title.y = element_text(size=14)) +
  theme(axis.text.x = element_text(size=12)) +
  stat_summary(fun.y="median", geom="point") +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 180)) + 
  scale_x_discrete(labels = c("Understory", "Co-dominant", "Dominant")) +
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Canopy Status") # + ggtitle("All Canopy Statuses") +
  #scale_fill_manual(values=rev(cbPalette))

#DBH Acer
acer.sort <- which(nsc.adult.total.mass.alive.common$genus == "Acer")
nsc.adult.acer <- nsc.adult.total.mass.alive.common[acer.sort,]

dbh.nsc.acer <- ggplot(nsc.adult.acer, aes(x = DBH14, y = total.nsc)) +
  geom_point(alpha = .3) +
  geom_smooth() +
  #geom_smooth(method = "gam", formula = y ~ s(x), size = 1) + # GAM model with smooth
  geom_smooth(method = "lm", col = "yellow") +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  #xlab("DBH") + 
  #theme(axis.text.x = element_text(size = 14)) +
  ggtitle("Acer")

lm.can.acer <- lm(total.nsc ~ Canopy15, data = nsc.adult.acer)
anova(lm.dbh.acer)
summary(lm.dbh.acer)

summary(aov.can.acer <- aov(lm.can.acer))
tukey.can.acer <- TukeyHSD(aov.can.acer, "Canopy15", ordered = FALSE)
plot(tukey.can.acer)
canopy.levels.acer <- tukey.can.acer[["Canopy15"]][,4]
canopy.labels.acer <- multcompLetters(canopy.levels.acer)['Letters']
canopy.plot.labels.acer <- names(canopy.labels.acer[['Letters']])

#Acer canopy 
canopy.nsc.acer <- ggplot(nsc.adult.acer[!is.na(nsc.adult.acer$Canopy15),], aes(x = as.factor(Canopy15), y = total.nsc)) +
  geom_violin() + theme(axis.text.x =   element_text(angle=0,hjust=.5,vjust = .5, size=8)) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_blank()) +
  stat_summary(fun.y="median", geom="point") +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 180)) + 
  scale_x_discrete(labels = c("Understory", "Co-dominant", "Dominant")) +
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Canopy Status") +
  annotate("text", x = 1:3, y = c(106, 129, 90), label = c("a","a","a")) +
  ggtitle("Acer")

#Combining all DBH plots into one figure#
nsc.dbh.common <- grid.arrange(dbh.nsc, dbh.nsc.quercus, dbh.nsc.fagus, dbh.nsc.tsuga, dbh.nsc.acer, ncol = 2, bottom = "DBH", left = textGrob(label = expression(paste("Total NSC mg g"^"-1")), rot = 90))

ggsave(filename = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Figures/nsc.dbh.commonspp.png", plot = nsc.dbh.common, dpi = 600, width = 4.5, height = 6, units = "in")

#Combining all Canopy plots into one figure
nsc.can.common <- grid.arrange(canopy.nsc, canopy.nsc.quercus, canopy.nsc.fagus, canopy.nsc.tsuga, canopy.nsc.acer, ncol = 2, bottom = "Canopy Status", left = textGrob(label = expression(paste("Total NSC mg g"^"-1")), rot = 90))

ggsave(filename = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Figures/nsc.can.commonspp.png", plot = nsc.can.common, dpi = 600, width = 5.5, height = 6.5, units = "in")

#Mortality
### some "A " and "A" rows - need to fix
lm.mortality <- lm(total.nsc ~ Mortality14, data = nsc.adult.total.mass)
anova(lm.mortality)
summary(lm.mortality)

ggplot(nsc.adult.total.mass, aes(x = Mortality14, y = total.nsc, fill = Mortality14)) +
  geom_boxplot() + theme(axis.text.x = element_text(angle=45,hjust=1,size=16)) +
  theme(axis.text.y = element_text(size=16)) +
  theme(axis.title.x = element_text(size=20)) +
  theme(axis.title.y = element_text(size=20)) +
  theme(legend.text = element_text(size=16)) +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 160)) + 
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Mortality Status") + ggtitle("All Mortality Statuses") +
#   geom_segment(aes(x=0,y=med.early.conif,xend=7.5,
#                    yend=med.early.conif),linetype="longdash",color="indianred4") +
#   geom_segment(aes(x=7.5,y=med.late.conif,xend=12,
#                    yend=med.late.conif),linetype="longdash",color="darkgreen") +
  scale_fill_manual(values=rev(cbPalette))

```

Region, Landscape, Microsite ANOVA exploratory analysis

```{r}
#, control=lmerControl(check.nobs.vs.nlev="ignore")
hierarchy.test <- lmer(total.nsc ~ DBH14 + (1|Site/Plot/Sub) + (1|Spp), data = nsc.adult.total.mass.alive.common)
 summary(hierarchy.test)
 plot((hierarchy.test))

#Site ANOVA
lm.site.total <- lm(total.nsc ~ Site, data = nsc.adult.total.mass.alive.common)
anova(lm.site.total)
summary(lm.site.total) #R^2 = 0.1997

#TukeyHSD site
#TukeyHSD PFT # p = .05
summary(aov.site <- aov(lm.site.total))
tukey.site <- TukeyHSD(aov.site, "Site", ordered = FALSE)
plot(tukey.site)
site.levels <- tukey.site[["Site"]][,4]
site.labels <- multcompLetters(site.levels)['Letters']
site.plot.labels <- names(site.labels[['Letters']])

site.nsc <- ggplot(nsc.adult.total.mass.alive.common, aes(x = Site, y = total.nsc)) +
  geom_violin() + theme(axis.text.x = element_text(angle=45,hjust=1,size=12)) +
  theme(axis.text.y = element_text(size=12)) +
  theme(axis.title.x = element_text(size=14)) +
  theme(axis.title.y = element_text(size=14)) +
  theme(legend.text = element_text(size=12)) +
  stat_summary(fun.y="median", geom="point") +
  stat_summary(fun.data = give.n, geom= "text", aes(y= 200), size = 3) + 
  ylab(expression(paste("Total NSC mg g"^"-1"))) + xlab("Site") +
  scale_fill_manual(values=rev(cbPalette)) +
  annotate("text", x = 1:10, y = c(125, 150, 128, 154, 148, 158, 162, 137, 182, 90), 
           label = c("bc","ab","abc","a","cd","e","a","a","f","d"), size = 3.5)

ggsave(filename = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Figures/TotalNSC.AllCommonSite.png", plot = site.nsc, dpi = 600, width = 7.5, height = 3.5, units = "in")

#Site x Plot ANOVA
lm.site.plot.total <- lm(total.nsc ~ Site/Plot, data = nsc.adult.total.mass.alive.common)
anova(lm.site.plot.total)
summary(lm.site.plot.total) #very few site * plot effects
```

Relationships between total, starch and sugars
```{r}
#starch v. total NSC
lm.starch2total <- lm(total.nsc ~ starch.mg.g, data = nsc.adult.total.mass.alive.common)
anova(lm.starch2total)
summary(lm.starch2total)
#strong correlation between starch and total nsc
#plot
plot(nsc.adult.total.mass$starch.mg.g, nsc.adult.total.mass$total.nsc)
abline(lm.starch2total)

#glucose v total NSC
lm.glucose2total <- lm(total.nsc ~ glucose.mg.g, data = nsc.adult.total.mass.alive.common)
anova(lm.glucose2total)
summary(lm.glucose2total)
#Very weak relationship between glucose and total
#Plot
plot(nsc.adult.total.mass$glucose.mg.g, nsc.adult.total.mass$total.nsc)
abline(lm.glucose2total)

#fructose v total NSC
lm.fructose2total <- lm(total.nsc ~ fructose.mg.g, data = nsc.adult.total.mass.alive.common)
anova(lm.fructose2total)
summary(lm.fructose2total)
#weak relationship between fructose and total
#Plot
plot(nsc.adult.total.mass$fructose.mg.g, nsc.adult.total.mass$total.nsc)
abline(lm.fructose2total)

#sucrose v total NSC
lm.sucrose2total <- lm(total.nsc ~ sucrose.mg.g, data = nsc.adult.total.mass.alive.common)
anova(lm.sucrose2total)
summary(lm.sucrose2total)
#Very weak relationship between glucose and total
#Plot
plot(nsc.adult.total.mass$sucrose.mg.g, nsc.adult.total.mass$total.nsc)
abline(lm.sucrose2total)

#Violin plots of componenets of NSCs

violin.glucose <- ggplot(nsc.adult.total.mass.alive.common, aes(x = nrow(nsc.adult.total.mass.alive.common), y = glucose.mg.g)) +
  geom_violin() +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x = element_blank()) +
  stat_summary(fun.y="median", geom="point") +
  labs(x = "Glucose", y = expression(paste("Concentration (mg g"^"-1",")"))) +
  ylim(0,172) +
  theme(plot.margin = unit(c(5.5,0,5.5,5.5), "pt"))

violin.fructose <- ggplot(nsc.adult.total.mass.alive.common, aes(x = nrow(nsc.adult.total.mass.alive.common), y = fructose.mg.g)) +
  geom_violin() +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x = element_blank()) +
  theme(axis.ticks.y = element_blank()) +
  theme(axis.text.y = element_blank()) +
  stat_summary(fun.y="median", geom="point") +
  labs(x = "Fructose", y = "") +
  ylim(0,172) +
  theme(plot.margin = unit(c(5.5,0,5.5,-5), "pt"))

violin.sucrose <- ggplot(nsc.adult.total.mass.alive.common, aes(x = nrow(nsc.adult.total.mass.alive.common), y = sucrose.mg.g)) +
  geom_violin() +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x = element_blank()) +
  theme(axis.ticks.y = element_blank()) +
  theme(axis.text.y = element_blank()) +
  stat_summary(fun.y="median", geom="point") +
  labs(x = "Sucrose", y = "") +
  ylim(0,172) +
  theme(plot.margin = unit(c(5.5,0,5.5,-5), "pt"))

violin.starch <- ggplot(nsc.adult.total.mass.alive.common, aes(x = nrow(nsc.adult.total.mass.alive.common), y = starch.mg.g)) +
  geom_violin() +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x = element_blank()) +
  theme(axis.ticks.y = element_blank()) +
  theme(axis.text.y = element_blank()) +
  stat_summary(fun.y="median", geom="point") +
  labs(x = "Starch", y = "") +
  #ylim(0,105) +
  ylim(0,172) +
  theme(plot.margin = unit(c(5.5,5.5,5.5,-5), "pt"))

violin.total <-ggplot(nsc.adult.total.mass.alive.common, aes(x = nrow(nsc.adult.total.mass.alive.common), y = total.nsc)) +
  geom_violin() +
  theme(axis.text.x = element_blank()) +
  theme(axis.ticks.x = element_blank()) +
  theme(axis.ticks.y = element_blank()) +
  theme(axis.text.y = element_blank()) +
  stat_summary(fun.y="median", geom="point") +
  labs(x = "Total NSC", y = "") +
  ylim(0,172) +
  theme(plot.margin = unit(c(5.5,5.5,5.5,-5), "pt"))

#combine component concentration plots
nsc.components <- grid.arrange(violin.glucose, violin.fructose, violin.sucrose, violin.starch, violin.total, ncol = 5)

ggsave(filename = "/Users/josh/Dropbox/Dissertation/CH2_NSC_Empirical/Figures/nsc.components.png", plot = nsc.components, dpi = 600, width = 8, height = 3.5, units = "in")

median(nsc.adult.total.mass.alive.common$glucose.mg.g, na.rm = TRUE) #8.06
median(nsc.adult.total.mass.alive.common$sucrose.mg.g, na.rm = TRUE) #13.6
median(nsc.adult.total.mass.alive.common$fructose.mg.g, na.rm = TRUE) #7.10
median(nsc.adult.total.mass.alive.common$starch.mg.g, na.rm = TRUE) #22.10
median(nsc.adult.total.mass.alive.common$total.nsc, na.rm = TRUE) #53.52

```
You can also embed plots, for example:

```{r fig.width=7, fig.height=6}
plot(cars)
```


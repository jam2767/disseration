Eastern US NSC Analysis
========================================================

This is the analysis for chapter 2 of my dissertation and for the first paper on nonstructural carbohydrates in eastern US forests.



```{r}
#load libraries
library(lme4)
library(ggplot2)

#helper functions
#function to find last value of vector
last <- function(x) { return( x[length(x)] ) }

#give sample size on boxplot for ggplot
give.n <- function(x){
  return(c(y = mean(x), label = length(x)))
}

#color-blind-friendly palettes
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

```{r}
#Directories for census and NSC data
#read data
#read Adult Census Data
adult <- read.csv("/Users/Josh/Dropbox/Dietze_Lab_Undergrads/JAM - Xsite/Field Data Entry/Data Sheets/Adult_Field_Data_JAM_MCD.csv")

#read NSC tracking data - contains sample mass used for assays
mass <- read.csv("/Users/Josh/Dropbox/NSC_Runs/All/Tracking/NSC_Mass_All_8172016.csv")

#all files starch files in one directory
data.dir.starch = "/Users/Josh/Dropbox/NSC_Runs/All/Starch"
data.dir.sugar = "/Users/Josh/Dropbox/NSC_Runs/All/Sugar"
```

```{r}
#Process STARCH data files
#starch files
files.starch <- dir(data.dir.starch,"Xsite")
baseline.files.starch <- files.starch[grep(pattern = "Baseline",files.starch)]
HK.files.starch <- files.starch[grep(pattern = "HK",files.starch)]

baseline.starch = NULL
for(i in seq_along(baseline.files.starch)){
  tmp <- read.csv(file.path(data.dir.starch,baseline.files.starch[i]),sep="",colClasses="character")
  baseline.starch = rbind(baseline.starch,tmp)
}
#mean.baseline.starch <- tapply(X = as.numeric(baseline.starch$Meas.), INDEX = baseline.starch$Sample, FUN = mean) #using mean of baseline - used for analysis through 9/1/2016, switching to last for future analysis. Last represents most accurate starting point for subtracting from sample after Hexokinase (HK) added.
last.baseline.starch <- tapply(X = as.numeric(baseline.starch$Meas.), INDEX = baseline.starch$Sample, FUN = last)
baseline.starch.id <- unique(baseline.starch$Sample)

#these files contain a run after HK is added
#measures starch content via breakdown of glucose & production of NADPH
HK.starch = NULL
for(i in seq_along(HK.files.starch)){
  tmp.HK.starch <- read.csv(file.path(data.dir.starch,HK.files.starch[i]),sep="",colClasses="character")
  HK.starch = rbind(HK.starch,tmp.HK.starch)
}
max.HK.starch <- tapply(X = as.numeric(HK.starch$Meas.), INDEX = HK.starch$Sample, FUN = max)
HK.starch.id <- unique(HK.starch$Sample)

# Check that samples finished converting all Starch. If not, flag for reanalysis
dif.HK.starch <- tapply(X = as.numeric(HK.starch$Meas.), INDEX = HK.starch$Sample, FUN = diff)
IDs <- as.vector(attr(dif.HK.starch,"dimnames"))
IDs <- unlist(IDs)

HK.nofinish <- list()
for(i in 1:length(dif.HK.starch)){
if ('0' %in% dif.HK.starch[[i]]) { #simplest check: time when absorbance not increasing?
  print("Sample Finished")
  } else {
  HK.nofinish[[i]] <- IDs[[i]] #ID of sample that didn't finish
  }
}

HK.nofinish.ids <- unlist(HK.nofinish) #remove null values
write.csv(HK.nofinish.ids, file = "unfinished_starch.csv") #save file to identify repeats

#### right now still using values for samples that didn't finish

#difference between baseline and HK
#total.starch <- max.HK.starch-mean.baseline.starch #old method using mean baseline value before 9/1/2016
total.starch <- max.HK.starch-last.baseline.starch #new method using last baseline value


##TODO use each standard curve for each individual plate
##currently only using one standard curve
#create standard curve equation

standard.abs.starch <- c(mean(total.starch[3:4]),mean(total.starch[1:2]),
                         mean(total.starch[5:6]),mean(total.starch[7:8]))
#standard.conc.starch <- c(0,0.5,1.0,1.5) #standard glucose concentrations in mmol for plate 2
standard.conc.starch <- c(0,20,40,60) #standard concentrations * 40 uL
standard.lm.starch <- lm(standard.abs.starch ~ standard.conc.starch)
summary(standard.lm.starch) #slope, intercept, R^2

#visualize standard curve
plot(standard.conc.starch,standard.abs.starch)
abline(standard.lm.starch)

#standard curve equation - calculate mmol glucose equivalents of samples
sample.conc.starch <- (total.starch - standard.lm.starch$coefficients[1])/standard.lm.starch$coefficients[2]
sample.conc.starch <- as.matrix(sample.conc.starch)
sample.ids.starch <- strsplit(row.names(sample.conc.starch),"_")

###create ID to match Core_ID in adult census data
core.id.starch <- array()
for(i in 1:length(sample.conc.starch)){
  core.id.starch[i] <- paste0(sample.ids.starch[[i]][1],
                              sample.ids.starch[[i]][2],
                              sample.ids.starch[[i]][3])
}

##bind core.id to sample matrix
sample.starch <- data.frame(core.id.starch,sample.conc.starch)
sample.agg.starch <- aggregate(sample.conc.starch~core.id.starch,sample.starch,mean)
matches.starch <- match(as.character(sample.agg.starch$core.id),as.character(adult$Core_ID14))
row.names(sample.agg.starch) <- NULL
nsc.adult.dat.starch <- data.frame(sample.agg.starch,adult[matches.starch,])

#match sample masses to absorbance
matches.mass.starch <- match(as.character(nsc.adult.dat.starch$Core_ID14),as.character(mass$Core_ID))
nsc.adult.starch.mass <- data.frame(nsc.adult.dat.starch,mass[matches.mass.starch,])

#mass column is Mass_mg
#calculate concentrations based on mass of sample used
nsc.adult.starch.mass$ug.sample <- nsc.adult.starch.mass$sample.conc.starch / 40 * 840 #micrograms/sample 40 ul drawn from 840 ul total volume of Starch Extraction
nsc.adult.starch.mass$Starch.mg.g <- nsc.adult.starch.mass$ug.sample / nsc.adult.starch.mass$Mass_mg #mg/gram of sample
```
You can also embed plots, for example:

```{r fig.width=7, fig.height=6}
plot(cars)
```

